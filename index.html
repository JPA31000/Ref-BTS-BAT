<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Référentiel BTS Bâtiment - Formulaire interactif</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Instrument Sans', sans-serif; 
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            min-height: 100vh;
        }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(30, 41, 59, 0.5); }
        ::-webkit-scrollbar-thumb { background: rgba(251, 191, 36, 0.3); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(251, 191, 36, 0.5); }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel">
const { useState, useMemo } = React;


// Liste des ressources documentaires selon le référentiel BTS Bâtiment
const ressourcesDocumentaires = {
  "0. Identification du projet": [
    "Nom du projet",
    "Nom MOA",
    "Nom MOE",
    "Architecte",
    "Bureau d'étude structure",
    "Bureau de contrôle",
    "SPS",
    "Acousticien",
    "Bureau d'étude thermique"
  ],
  "1. Documents du dossier marché (DCE)": {
    "Pièces Écrites": [
      "CCTP",
      "CCAP",
      "CCAG",
      "RICT",
      "PGC",
      "Rapports d'études de sols"
    ],
    "Pièces Graphiques": [
      "Plan PRO ARC",
      "Plan PRO ST",
      "Plan PRO CVC",
      "Plans de prévention",
      "Plans de circulation"
    ],
    "Pièces Temporelles": [
      "Planning prévisionnel"
    ]
  },
  "2. Documents d'exécution et techniques": [
    "Dossier d'exécution",
    "Plans de coffrage",
    "Plans de ferraillage",
    "Plans de pose",
    "Croquis et schémas techniques",
    "Notes de calculs",
    "Fiches techniques",
    "Maquette numérique (BIM)"
  ],
  "3. Documents de gestion, organisation et suivi": [
    "Planning d'exécution détaillé",
    "PIC",
    "Budget prévisionnel",
    "Budget travaux",
    "Modes opératoires",
    "Comptes rendus de réunions de chantier",
    "Situations de travaux"
  ],
  "4. Documents administratifs et réglementaires": [
    "DICT",
    "Autorisations administratives",
    "Normes",
    "DTU",
    "Réglementations",
    "Certifications"
  ]
};

const connaissancesGlobales = [
  { id: 1, nom: "Projet de construction et cadre réglementaire", competences: ["C1", "C2", "C3", "C4", "C5", "C6", "C7", "C8", "C9", "C10", "C11", "C12", "C13", "C14", "C15"] },
  { id: 2, nom: "Construction durable", competences: ["C1", "C2", "C3", "C4", "C5", "C6", "C7", "C8", "C9", "C10", "C11", "C12", "C13", "C14", "C15"] },
  { id: 3, nom: "Environnement numérique d'un projet", competences: ["C1", "C2", "C3", "C4", "C5", "C6", "C7", "C8", "C9", "C10", "C11", "C12", "C13", "C14", "C15"] },
  { id: 4, nom: "Sciences de la construction", competences: ["C1", "C2", "C4", "C15"] },
  { id: 5, nom: "Ouvrages et procédés de réalisation", competences: ["C1", "C2", "C4", "C7", "C9"] },
  { id: 6, nom: "Management et communication", competences: ["C1", "C2", "C3", "C4", "C5", "C6", "C7", "C8", "C9", "C10", "C11", "C12", "C13", "C14", "C15"] },
  { id: 7, nom: "Santé et sécurité au travail", competences: ["C1", "C2", "C3", "C4", "C5", "C6", "C7", "C8", "C9", "C11", "C12", "C13", "C14", "C15"] },
  { id: 8, nom: "Préparation et organisation de chantier", competences: ["C6", "C7", "C8", "C9", "C10", "C11"] },
  { id: 9, nom: "Économie de la construction", competences: ["C3", "C8", "C10", "C11"] },
  { id: 10, nom: "Implantations - Contrôles", competences: ["C14"] },
  { id: 11, nom: "Démarche qualité", competences: ["C1", "C2", "C3", "C4", "C5", "C6", "C7", "C8", "C9", "C11", "C13", "C14", "C15"] }
];

const data = {
  blocs: [
    {
      id: 1,
      nom: "Analyse et proposition de solutions techniques",
      unite: "U5",
      poles: [
        {
          id: "A1.1",
          nom: "Analyse et choix d'une solution technique",
          conditionsExercice: {
            moyens: [
              "Extraits du dossier marché (CCTP, plans d'architecte, études de sols, PGC, plan de prévention, plan de circulation…)",
              "Extraits du dossier d'exécution",
              "Données du site (bâtiment neuf ou existant)",
              "Réglementations, normes, certifications en vigueur",
              "Environnement professionnel de l'entreprise (matériel, QSE, RSE, bases de données)"
            ],
            autonomie: "Partielle"
          },
          resultatsAttendus: {
            "T1.1": [
              "Le besoin du client est analysé et explicité",
              "Les contraintes et les exigences du projet sont identifiées",
              "Les besoins et impossibilités techniques sont explicités"
            ],
            "T1.2": [
              "La solution technique est analysée",
              "Les points forts et les points de vigilance sont identifiés",
              "Les solutions sont comparées et un choix est opéré"
            ]
          },
          taches: [
            { id: "T1.1", nom: "Explicitation d'un besoin et formalisation de tout ou partie d'un cahier des charges", competences: ["C1"] },
            { id: "T1.2", nom: "Analyse et choix d'une solution technique", competences: ["C1"] }
          ]
        },
        {
          id: "A1.2",
          nom: "Proposition d'une solution technico-économique",
          conditionsExercice: {
            moyens: [
              "Extraits du dossier marché (CCTP, plans d'architecte, études de sols, PGC, plan de prévention…)",
              "Extraits du dossier d'exécution",
              "Données du site (bâtiment neuf ou existant)",
              "Réglementations, normes, certifications en vigueur",
              "Environnement professionnel de l'entreprise (matériel, QSE, RSE, bases de données)"
            ],
            autonomie: "Partielle"
          },
          resultatsAttendus: {
            "T1.3": [
              "La solution technique est détaillée (choix des matériaux, méthodes, interfaces…) et argumentée",
              "La solution technique est décrite graphiquement",
              "La solution technique respecte les exigences réglementaires et du cahier des charges (mécanique, thermique, acoustique, impact carbone)"
            ],
            "T1.4": [
              "Les charges mécaniques sont décrites et estimées",
              "Un modèle mécanique est proposé",
              "Un calcul de dimensionnement manuel est réalisé",
              "Éléments limités à : élingues, étais, semelles de fondation, poutres isostatiques, poutres continues sans calcul hyperstatique, éléments en porte à faux, fixations, poteaux"
            ],
            "T1.5": [
              "Des détails constructifs sont élaborés : principes de ferraillage, interfaces, assemblages, composition des parois, croquis d'étaiement, positionnement des élingues",
              "Des coupes ou des vues nécessaires à la définition d'une solution technique sont réalisées",
              "Des schémas précisant les principes de réalisation en sécurité sont proposés"
            ],
            "T1.6": [
              "Un quantitatif est réalisé sur une partie de l'ouvrage",
              "Un prix de vente est proposé sur une partie de l'ouvrage",
              "La proposition technique et commerciale est réalisée"
            ]
          },
          taches: [
            { id: "T1.3", nom: "Proposition d'une solution technique", competences: ["C2"] },
            { id: "T1.4", nom: "Dimensionnement manuel des éléments structurels courants", competences: ["C2"] },
            { id: "T1.5", nom: "Réalisation de croquis et de schémas", competences: ["C2"] },
            { id: "T1.6", nom: "Rédaction d'une proposition commerciale pour une variante ou des travaux supplémentaires", competences: ["C3"] }
          ]
        }
      ],
      competences: [
        {
          id: "C1",
          nom: "Analyser un cahier des charges, un contexte, des solutions techniques",
          connaissances: [
            { nom: "Sciences de la construction", niveau: 4 },
            { nom: "Ouvrages et procédés de réalisation", niveau: 4 }
          ],
          criteres: [
            "Le cahier des charges est analysé et explicité par une synthèse",
            "Les points de vigilance sont identifiés et explicités : besoins, exigences, contraintes, incohérences éventuelles, impossibilités techniques",
            "Des solutions techniques sont analysées et/ou comparées selon plusieurs critères : technologie, mise en œuvre, coût, impact environnemental, sécurité",
            "Un choix technique est réalisé et justifié"
          ],
          taches: ["T1.1", "T1.2"]
        },
        {
          id: "C2",
          nom: "Proposer une solution technique pour le projet, pour une variante ou des travaux supplémentaires",
          connaissances: [
            { nom: "Sciences de la construction", niveau: 4 },
            { nom: "Ouvrages et procédés de réalisation", niveau: 4 }
          ],
          criteres: [
            "Les charges mécaniques sont décrites et estimées pour un ouvrage élémentaire courant de structure en béton armé, en bois ou en acier",
            "Un modèle mécanique est proposé",
            "Un calcul de dimensionnement manuel est réalisé (semelles, poutres isostatiques, poutres continues, porte à faux, fixations, poteaux)",
            "Un équipement de chantier ou de réalisation est dimensionné ou vérifié : étaiement, plateforme de sécurité, coffrage, garde-corps, apparaux de levage",
            "La solution technique est proposée et justifiée par rapport aux exigences réglementaires et au cahier des charges",
            "La solution technique est représentée sous forme de croquis ou de schémas"
          ],
          taches: ["T1.3", "T1.4", "T1.5"]
        },
        {
          id: "C3",
          nom: "Estimer économiquement une étude d'avant-projet",
          connaissances: [
            { nom: "Économie de la construction", niveau: 4 }
          ],
          criteres: [
            "Le quantitatif d'une partie d'ouvrage est établi",
            "Le prix de vente d'une partie d'ouvrage est établi à partir de données fournies",
            "La proposition technique et commerciale est finalisée"
          ],
          taches: ["T1.6"]
        }
      ]
    },
    {
      id: 2,
      nom: "Étude et préparation de chantier",
      unite: "U6",
      poles: [
        {
          id: "A2.1",
          nom: "Analyse et étude d'un projet",
          conditionsExercice: {
            moyens: [
              "Dossier marché (CCTP, plans d'architecte, études de sols, PGC, plan de prévention, plan de circulation)",
              "Dossier d'exécution",
              "Données du site (bâtiment neuf ou existant)",
              "Base de données entreprise (temps unitaires, cadences)",
              "Réglementations, normes, certifications en vigueur",
              "Démarche QSE de l'entreprise",
              "Démarche RSE de l'entreprise si elle existe (démarche bas carbone)",
              "Environnement professionnel de l'entreprise (progiciels, matériel, outils numériques)"
            ],
            autonomie: "Partielle"
          },
          resultatsAttendus: {
            "T2.1": [
              "Une synthèse globale justifiée et structurée est rédigée en prenant en compte : les besoins, les exigences, les contraintes, les incohérences éventuelles, les impossibilités techniques"
            ],
            "T2.2": [
              "Les plans de structure sont produits",
              "Les éléments porteurs et leurs impacts sont identifiés",
              "Les incohérences éventuelles sont relevées",
              "Des solutions simples et adaptées sont proposées",
              "Des plans d'exécution sont réalisés"
            ],
            "T2.3": [
              "Le PGCSPS est analysé s'il existe",
              "Le PPSPS est complété par le PIC, les modes opératoires…",
              "Les risques sont identifiés et évalués",
              "Les moyens de prévention sont choisis en fonction de cette évaluation et des principes généraux de prévention"
            ],
            "T2.4": [
              "Les risques environnementaux sont anticipés",
              "Les acteurs sont identifiés",
              "Les documents réglementaires et normatifs sont connus et complétés",
              "Les méthodes de gestion des déchets sont mises en place",
              "L'impact environnemental est optimisé"
            ],
            "T2.5": [
              "Le CCTP est analysé en identifiant les exigences de qualité",
              "Les points singuliers et les interfaces sur chantier sont identifiés"
            ]
          },
          taches: [
            { id: "T2.1", nom: "Analyse globale du projet", competences: ["C4"] },
            { id: "T2.2", nom: "Analyse du fonctionnement mécanique d'un bâtiment neuf ou existant", competences: ["C4"] },
            { id: "T2.3", nom: "Analyse des risques pour la santé et la sécurité", competences: ["C5"] },
            { id: "T2.4", nom: "Analyse des exigences environnementales", competences: ["C5"] },
            { id: "T2.5", nom: "Analyse des exigences de qualité", competences: ["C5"] }
          ]
        },
        {
          id: "A2.2",
          nom: "Préparation de chantier",
          conditionsExercice: {
            moyens: [
              "Dossier marché (CCTP, plans d'architecte, études de sols, PGC, plan de prévention, plan de circulation)",
              "Dossier d'exécution",
              "Données du site",
              "Base de données entreprise (temps unitaires, cadences, coûts)",
              "Réglementations, normes, certifications en vigueur",
              "Démarche QSE de l'entreprise",
              "Démarche RSE de l'entreprise si elle existe",
              "Environnement professionnel de l'entreprise (progiciels, matériel, outils numériques)"
            ],
            autonomie: "Partielle"
          },
          resultatsAttendus: {
            "T2.6": [
              "Les services compétents (DREETS, CARSAT, OPPBTP…) sont informés de l'ouverture du chantier",
              "À partir de la déclaration de travaux, les DICT sont demandées, étudiées et exploitées",
              "Les autorisations nécessaires (voirie, survol, engins de levage…) sont demandées aux services compétents"
            ],
            "T2.7": [
              "Le planning de chantier objectif est réalisé à partir du planning client (ajout d'une marge de sécurité)",
              "Les modes constructifs possibles sont comparés et le choix est justifié en fonction des contraintes techniques, économiques, environnementales et de prévention",
              "Un tableau de synthèse est réalisé"
            ],
            "T2.8": [
              "Les équipes sont définies",
              "Le type et la quantité de matériel sont définis et optimisés",
              "La charge de grue est réalisée et est cohérente",
              "Le type et la quantité de matériaux sont définis et optimisés",
              "Le mode de fabrication du béton est choisi"
            ],
            "T2.9": [
              "Les ouvrages élémentaires sont décomposés et quantifiés",
              "Le planning réalisé fait apparaître : la décomposition des tâches, l'enclenchement des tâches, la durée des tâches, les cadences",
              "Les jours non travaillés (congés, jours fériés, jours prévus pour intempéries) sont intégrés",
              "Les principales phases de logistique (livraisons…), les dates-jalons, le phasage si besoin sont définis",
              "La courbe de main d'œuvre est établie"
            ],
            "T2.10": [
              "Le cyclage des verticaux et des horizontaux est réalisé",
              "La rotation du matériel (coffrage et sécurité) est réalisable, cohérente voire optimisée",
              "Le calepinage des éléments préfabriqués est défini"
            ],
            "T2.11": [
              "Le plan d'installation de chantier est réalisé et mis à jour selon l'avancement du chantier",
              "Les moyens relatifs aux exigences de qualité, de prévention et environnementales sont définis",
              "Les engins de levage sont choisis, dimensionnés et positionnés en intégrant les phases de montage et de démontage",
              "Les zones de stockage sont définies",
              "La base vie, les accès, les circulations piétons et engins, les clôtures, les réseaux, les zones de stockage des déchets, les zones de terrassement, la zone d'approvisionnement sont définis"
            ],
            "T2.12": [
              "Les risques sont identifiés et évalués",
              "Les moyens de prévention sont choisis en fonction de cette évaluation",
              "Les points singuliers et les interfaces sur chantier sont identifiés",
              "Le matériel est choisi et adapté",
              "Les méthodes d'exécution sont définies"
            ],
            "T2.13": [
              "Les éléments suivants sont budgétés dans le cadre d'un déboursé sec d'un ouvrage élémentaire : main d'œuvre, matériaux, matériels, sous-traitants",
              "Les frais de chantier sont évalués",
              "Pour budgéter les matériaux et le matériel, les fournisseurs sont consultés"
            ]
          },
          taches: [
            { id: "T2.6", nom: "Recensement des démarches préalables à l'ouverture de chantier", competences: ["C6"] },
            { id: "T2.7", nom: "Définition des modes constructifs dans le cadre d'un planning objectif", competences: ["C7"] },
            { id: "T2.8", nom: "Choix et définition des moyens de réalisation à partir du planning objectif", competences: ["C7"] },
            { id: "T2.9", nom: "Élaboration d'un planning d'exécution détaillé", competences: ["C8"] },
            { id: "T2.10", nom: "Élaboration de cycles de travaux en cohérence avec le planning d'exécution détaillé", competences: ["C9"] },
            { id: "T2.11", nom: "Élaboration du plan d'installation de chantier", competences: ["C9"] },
            { id: "T2.12", nom: "Conception des modes opératoires sur chantier incluant la démarche QSE", competences: ["C9"] },
            { id: "T2.13", nom: "Élaboration d'un budget travaux", competences: ["C10"] }
          ]
        }
      ],
      competences: [
        {
          id: "C4",
          nom: "Analyser et finaliser la structure en fonction des choix constructifs",
          connaissances: [
            { nom: "Sciences de la construction", niveau: 4 },
            { nom: "Ouvrages et procédés de réalisation", niveau: 4 }
          ],
          criteres: [
            "Les éléments nécessaires à l'étude et à la préparation de chantier sont identifiés dans un dossier marché et explicités dans une note de synthèse",
            "Le fonctionnement de la structure porteuse d'un bâtiment est analysé : plans d'avant-projet structure, éléments porteurs, schéma de cheminement des charges",
            "Des hypothèses de chargement sont formulées et justifiées, des solutions simples et adaptées sont proposées",
            "Une descente de charges est réalisée avec un outil informatique et contrôlée sur un élément isolé",
            "Des plans d'exécution sont réalisés avec des progiciels 2D ou 3D, les normes de dessins sont respectées",
            "La maquette BIM « structure » d'une partie de l'ouvrage est finalisée"
          ],
          taches: ["T2.1", "T2.2"]
        },
        {
          id: "C5",
          nom: "Analyser et définir les moyens relatifs aux exigences de qualité, de prévention et d'environnement",
          connaissances: [
            { nom: "Connaissances transversales", niveau: 4 }
          ],
          criteres: [
            "Les enjeux et procédures liés à la prévention des risques sont analysés : PGC, PPSPS, risques identifiés et évalués, moyens de prévention choisis",
            "Le travail en hauteur est pris en compte",
            "Les enjeux et procédures liés à l'impact environnemental sont analysés : risques anticipés, documents réglementaires, gestion des déchets",
            "Les enjeux et procédures liés à la qualité sont analysés : CCTP, exigences de qualité, sur-exigences et impossibilités identifiées"
          ],
          taches: ["T2.3", "T2.4", "T2.5"]
        },
        {
          id: "C6",
          nom: "Réaliser les démarches nécessaires à l'ouverture du chantier",
          connaissances: [
            { nom: "Préparation et organisation de chantier", niveau: 4 }
          ],
          criteres: [
            "Les services compétents (DREETS, CARSAT, OPPBTP…) sont informés de l'ouverture du chantier",
            "Les éléments nécessaires à la DICT sont préparés sur un document",
            "L'Intervention à Proximité des Réseaux est analysée",
            "Les autorisations nécessaires (voirie, survol, engins de levage…) sont complétées"
          ],
          taches: ["T2.6"]
        },
        {
          id: "C7",
          nom: "Choisir et définir les moyens nécessaires à l'organisation du chantier",
          connaissances: [
            { nom: "Préparation et organisation de chantier", niveau: 4 },
            { nom: "Ouvrages et procédés de réalisation", niveau: 4 },
            { nom: "Économie de la construction", niveau: 4 }
          ],
          criteres: [
            "Le délai d'exécution objectif est défini à partir du délai client en incluant les marges et aléas",
            "Les modes constructifs possibles sont comparés, le choix est justifié et un tableau de synthèse est réalisé",
            "Le choix de la cinématique de réalisation permet de valider le planning objectif",
            "Les crédits d'heures sont calculés et les équipes sont définies",
            "Le type et la quantité de matériel, matériaux et consommables sont définis et optimisés"
          ],
          taches: ["T2.7", "T2.8"]
        },
        {
          id: "C8",
          nom: "Réaliser le planning d'exécution détaillé",
          connaissances: [
            { nom: "Préparation et organisation de chantier", niveau: 4 }
          ],
          criteres: [
            "Les ouvrages élémentaires sont décomposés et quantifiés",
            "Le planning d'exécution détaillé fait apparaître : décomposition et enclenchement des tâches, durées, cadences, jours non travaillés",
            "Les principales phases logistiques, dates-jalons et phasage sont intégrés",
            "La courbe de main d'œuvre est établie"
          ],
          taches: ["T2.9"]
        },
        {
          id: "C9",
          nom: "Élaborer les processus de réalisation détaillés et les modes opératoires",
          connaissances: [
            { nom: "Préparation et organisation de chantier", niveau: 4 },
            { nom: "Ouvrages et procédés de réalisation", niveau: 4 }
          ],
          criteres: [
            "Le plan d'installation de chantier est réalisé en plan et en coupe : emprise, engins de levage, base vie, clôtures, réseaux, zones de stockage",
            "Le mode de fabrication du béton est choisi",
            "Des modes opératoires sur chantier sont élaborés : décomposition chronologique, procédés d'exécution, matériels, risques évalués, moyens de prévention",
            "Des rotations de matériels et de poses des éléments industriels sont réalisées : cyclage, rotation du matériel, calepinage",
            "L'interface avec les autres corps d'états est traitée, les points singuliers sont analysés"
          ],
          taches: ["T2.10", "T2.11", "T2.12"]
        },
        {
          id: "C10",
          nom: "Établir le budget prévisionnel de l'opération",
          connaissances: [
            { nom: "Économie de la construction", niveau: 4 }
          ],
          criteres: [
            "Le déboursé sec d'un ouvrage élémentaire est budgété : main d'œuvre, matériaux, matériels, consommables, sous-traitants",
            "Les frais de chantier sont listés",
            "Pour budgéter les matériaux et le matériel, les fournisseurs sont éventuellement consultés"
          ],
          taches: ["T2.13"]
        }
      ]
    },
    {
      id: 3,
      nom: "Suivi et encadrement d'un projet",
      unite: "U7",
      poles: [
        {
          id: "A3.1",
          nom: "Suivi d'un projet",
          conditionsExercice: {
            moyens: [
              "Dossier marché (CCTP, plans d'architecte, études de sols, PGC, plan de prévention…)",
              "Dossier d'exécution",
              "Dossier méthodes (PIC, plannings, rotations, phasage, sécurité, modes opératoires…)",
              "Données du site (bâtiment neuf ou existant)",
              "Base de données entreprise (temps unitaires, cadences…)",
              "Réglementations, normes, certifications en vigueur",
              "Démarche QSE de l'entreprise",
              "Démarche RSE de l'entreprise si elle existe (démarche bas carbone…)",
              "Environnement professionnel de l'entreprise (progiciels, matériel, outils numériques, formulaires…)"
            ],
            autonomie: "Partielle"
          },
          resultatsAttendus: {
            "T3.1": [
              "La visite du chantier est effectuée",
              "L'état d'avancement des ouvrages est estimé",
              "La mise en place des dispositifs de sécurité est contrôlée tout au long du chantier",
              "La conformité des ouvrages est vérifiée",
              "L'avancement des travaux est reporté sur le planning d'exécution"
            ],
            "T3.2": [
              "Les situations sont établies suivant l'avancement des travaux",
              "Les données sont transmises pour facturation",
              "Les dépenses communes sont transmises pour établissement des factures du compte prorata"
            ],
            "T3.3": [
              "Le plan d'assurance qualité de l'entreprise est appliqué (points d'arrêt, points de contrôle, mesures de reprise, gestion des non-conformités...)",
              "Les ouvrages sont contrôlés tout au long du projet",
              "Les données du projet sont suivies et mises à jour",
              "Les résultats sont consignés et réalisés"
            ],
            "T3.4": [
              "Le contenu de la communication est adapté au contexte et à l'interlocuteur (arguments, éléments de langage…)",
              "Les moyens de communication sont appropriés au contexte",
              "Les communications sont préparées",
              "Les interventions sont assurées, suivies, comprises par les destinataires, et contrôlées avec la qualité attendue",
              "Les arguments des interlocuteurs sont pris en compte",
              "Les comptes rendus formels et informels sont assurés à l'écrit ou à l'oral et conformes aux attendus"
            ],
            "T3.5": [
              "Les réglementations, normes, recommandations et certifications en vigueur sont connues et appliquées",
              "La veille technologique est assurée"
            ],
            "T3.6": [
              "Le contrôle des factures des fournisseurs est réalisé",
              "Le suivi des crédits d'heures est assuré",
              "Le suivi de la consommation des produits et matériaux est fait",
              "Les résultats intermédiaires sont analysés en vue d'une optimisation éventuelle",
              "Les écarts avec le budget sont analysés, le budget est éventuellement recalé"
            ]
          },
          taches: [
            { id: "T3.1", nom: "Contrôle et suivi de l'avancement du projet", competences: ["C11"] },
            { id: "T3.2", nom: "Établissement des situations d'avancement de travaux", competences: ["C11"] },
            { id: "T3.3", nom: "Suivi du processus management qualité de l'entreprise", competences: ["C13"] },
            { id: "T3.4", nom: "Participation à une réunion", competences: ["C12"] },
            { id: "T3.5", nom: "Application des réglementations, des normes et des certifications en vigueur", competences: ["C13"] },
            { id: "T3.6", nom: "Suivi du budget du chantier", competences: ["C11"] }
          ]
        },
        {
          id: "A3.2",
          nom: "Encadrement d'un projet",
          conditionsExercice: {
            moyens: [
              "Dossier marché (CCTP, plans d'architecte, études de sols, PGC…)",
              "Dossier d'exécution",
              "Dossier méthodes (PIC, plannings, rotations, phasage, sécurité, modes opératoires…)",
              "Données du site (bâtiment neuf ou existant)",
              "Base de données entreprise (temps unitaires, cadences…)",
              "Réglementations, normes, certifications en vigueur",
              "Démarche QSE de l'entreprise",
              "Démarche RSE de l'entreprise si elle existe (démarche bas carbone…)",
              "Environnement professionnel de l'entreprise (progiciels, matériel, outils numériques, formulaires…)"
            ],
            autonomie: "Partielle"
          },
          resultatsAttendus: {
            "T3.7": [
              "Les différents intervenants sont identifiés",
              "Les interfaces avec les autres corps d'état sont définies ou prises en compte",
              "La mutualisation des moyens est analysée",
              "La coactivité est anticipée et gérée",
              "Les rôles et responsabilités de chacun sont identifiés",
              "Les relations et interfaces avec les parties prenantes sont préparées et assurées (MOA, MOE, riverains, concessionnaires, CARSAT, DREETS…)"
            ],
            "T3.8": [
              "L'accueil, l'information, la formation des équipes sont réalisés",
              "La présentation des travaux confiés à l'équipe est préparée",
              "Les rôles et responsabilités de chacun sont définis, attribués, délégués si besoin",
              "L'animation de l'équipe est assurée",
              "Les règles de travail de l'entreprise et du chantier sont mises en œuvre",
              "Les imprévus, difficultés ou conflits de l'équipe sont pris en compte et sont gérés",
              "La posture de représentant de l'entreprise est adaptée aux différents contextes"
            ],
            "T3.9": [
              "Les salariés sont accueillis (livret et fiche d'accueil) et la formation au poste de travail est dispensée",
              "Les documents réglementaires sont contrôlés et appliqués (habilitations, certifications, CACES, autorisations…)",
              "Les règles, les moyens de prévention et de protection sont appliqués",
              "Les informations et les formations sont mises en œuvre (quart d'heure sécurité, nutrition, éveil musculaire, postures)",
              "Les situations à risques sont identifiées, traitées et les parties prenantes en sont informées",
              "Les moyens de prévention prévus sont adaptés en continu au site",
              "Les situations d'urgence, les incidents, les presqu'accidents sont gérés",
              "Les consignes de vérification, d'utilisation et de guidage des matériels et outils sont contrôlées et appliquées",
              "Les équipements sont contrôlés (sécurité, étalonnage)",
              "La VGP des équipements est à jour et les réserves sont levées",
              "Les marquages, la signalisation de chantier et les protections sont maintenus en état"
            ],
            "T3.10": [
              "L'empreinte environnementale du chantier est minimisée",
              "La gestion des déchets est contrôlée et appliquée",
              "Les prestataires d'évacuation sont identifiés",
              "Les stations de lavage sont en place",
              "Les contraintes et les risques de nuisances sont traités (bruit, pollution)",
              "Les ressources sont économisées dans le cadre d'une démarche écoresponsable"
            ],
            "T3.11": [
              "Les plannings de livraison sont établis et coordonnés (DHOL)",
              "Le suivi et le contrôle des commandes et des livraisons des matériels et des matériaux sont assurés et explicités",
              "Les zones de stockage et de livraison sont respectées",
              "Les procédures de maintenance et de dépannage sont appliquées",
              "Les démarches d'optimisation sont initiées",
              "Les tâches à zéro valeur ajoutée sont éliminées"
            ]
          },
          taches: [
            { id: "T3.7", nom: "Prise en compte des différents intervenants du projet", competences: ["C12"] },
            { id: "T3.8", nom: "Management d'une équipe", competences: ["C12"] },
            { id: "T3.9", nom: "Organisation et mise en œuvre de la sécurité des personnes et des biens", competences: ["C13"] },
            { id: "T3.10", nom: "Organisation et mise en œuvre des mesures environnementales sur chantier", competences: ["C13"] },
            { id: "T3.11", nom: "Organisation, logistique et gestion des matériels et des matériaux", competences: ["C12"] }
          ]
        }
      ],
      competences: [
        {
          id: "C11",
          nom: "Assurer le suivi de l'opération",
          connaissances: [
            { nom: "Préparation et organisation de chantier", niveau: 4 },
            { nom: "Économie de la construction", niveau: 4 }
          ],
          criteres: [
            "La gestion des plannings est suivie, analysée, et des ajustements sont proposés si besoin",
            "La participation à une réunion est effective et un compte rendu est rédigé",
            "Les situations d'avancement de travaux sont analysées",
            "Un relevé de cadence et de consommations est réalisé sur la production d'un ouvrage",
            "La procédure de suivi des coûts du chantier est analysée",
            "Les écarts entre le prévisionnel et le réel sont analysés et des actions correctives sont proposées",
            "La réception des ouvrages est préparée et formalisée dans une fiche"
          ],
          taches: ["T3.1", "T3.2", "T3.4", "T3.6", "T3.11"]
        },
        {
          id: "C12",
          nom: "Participer au management d'une équipe",
          connaissances: [
            { nom: "Connaissances transversales", niveau: 4 }
          ],
          criteres: [
            "Des activités de management observées sont analysées : accueil, formation au poste, information des équipes",
            "Les différents intervenants sont identifiés et leur rôle est explicité, les interfaces avec les autres corps d'état sont explicitées",
            "La communication orale et écrite est adaptée à la situation et à l'interlocuteur",
            "Une consigne de réalisation d'une tâche est transmise et explicitée à partir de la lecture de plans",
            "Les comptes rendus formels et informels sont assurés à l'écrit ou à l'oral",
            "La collaboration et l'encadrement de la réalisation des projets sont observés et analysés"
          ],
          taches: ["T3.7", "T3.8"]
        },
        {
          id: "C13",
          nom: "Participer à la mise en œuvre des mesures de sécurité des personnes et des biens, des mesures environnementales et de la démarche qualité",
          connaissances: [
            { nom: "Connaissances transversales", niveau: 4 }
          ],
          criteres: [
            "La prévention des risques pour la santé et la sécurité est analysée : documents réglementaires, situations à risques, moyens de prévention, gestion des situations d'urgence",
            "Les consignes de vérification, d'utilisation et de guidage des matériels et outils sont maîtrisées",
            "La VGP et le contrôle des équipements sont suivis",
            "Les démarches environnementales sont analysées : documents réglementaires, gestion des déchets, traitement des eaux, nuisances",
            "Le processus management qualité de l'entreprise est analysé : plan d'assurance qualité, contrôle des ouvrages, fiches d'autocontrôle"
          ],
          taches: ["T3.3", "T3.5", "T3.9", "T3.10"]
        }
      ]
    },
    {
      id: 4,
      nom: "Contrôle qualité et réception des ouvrages",
      unite: "U8",
      poles: [
        {
          id: "A4.1",
          nom: "Réception et implantation",
          conditionsExercice: {
            moyens: [
              "Dossier marché (CCTP, plans d'architecte, études de sols, PGC…)",
              "Dossier d'exécution",
              "Dossier méthodes (PIC, plannings, rotations, phasage, sécurité, modes opératoires…)",
              "Données du site (bâtiment neuf ou existant)",
              "Base de données entreprise (temps unitaires, cadences…)",
              "Réglementations, normes, certifications en vigueur",
              "Démarche QSE de l'entreprise",
              "Démarche RSE de l'entreprise si elle existe (démarche bas carbone…)",
              "Environnement professionnel de l'entreprise (progiciels, matériel, outils numériques, formulaires…)"
            ],
            autonomie: "Partielle"
          },
          resultatsAttendus: {
            "T4.1": [
              "Le plan de contrôle est établi en précisant les tolérances requises",
              "Le relevé des supports en altimétrie et planimétrie est effectué",
              "La fiche de réception du lot en interface est établie en indiquant, le cas échéant, les mesures correctives exigées"
            ],
            "T4.2": [
              "L'implantation des limites du chantier est matérialisée, ainsi que la localisation des principales zones du chantier (accès, stockages, sécurités…)",
              "L'implantation des ouvrages est réalisée"
            ]
          },
          taches: [
            { id: "T4.1", nom: "Réception des supports et validation des interfaces", competences: ["C14"] },
            { id: "T4.2", nom: "Implantation des ouvrages", competences: ["C14"] }
          ]
        },
        {
          id: "A4.2",
          nom: "Contrôle et validation",
          conditionsExercice: {
            moyens: [
              "Dossier marché (CCTP, plans d'architecte, études de sols, PGC…)",
              "Dossier d'exécution",
              "Dossier méthodes (PIC, plannings, rotations, phasage, sécurité, modes opératoires…)",
              "Données du site (bâtiment neuf ou existant)",
              "Base de données entreprise (temps unitaires, cadences…)",
              "Réglementations, normes, certifications en vigueur",
              "Démarche QSE de l'entreprise",
              "Démarche RSE de l'entreprise si elle existe (démarche bas carbone…)",
              "Environnement professionnel de l'entreprise (progiciels, matériel, outils numériques, formulaires…)"
            ],
            autonomie: "Partielle"
          },
          resultatsAttendus: {
            "T4.3": [
              "Les fiches de réceptions sont remplies",
              "Les contrôles des solutions techniques et des matériaux sont réalisés",
              "Les contrôles des ouvrages sont réalisés conformément au plan de contrôle",
              "Les fiches de contrôles sont établies et transmises",
              "Les non conformités sont identifiées et traitées"
            ]
          },
          taches: [
            { id: "T4.3", nom: "Vérification et validation des solutions techniques, des matériaux et des ouvrages réalisés", competences: ["C15"] }
          ]
        }
      ],
      competences: [
        {
          id: "C14",
          nom: "Implanter et vérifier les caractéristiques géométriques des ouvrages",
          connaissances: [
            { nom: "Implantations - Contrôles", niveau: 4 }
          ],
          criteres: [
            "Des points ou des axes sont implantés : travaux préparés, données établies de manière informatique, implantations réalisées et contrôlées",
            "Les traits de niveau sont positionnés",
            "Les interfaces sont validées",
            "Des coffrages, des inserts sont tracés pour les ouvrages courants",
            "Les relevés d'ouvrages sont réalisés suivant un plan de contrôle : géométrie, dimensions, positionnement"
          ],
          taches: ["T4.1", "T4.2"]
        },
        {
          id: "C15",
          nom: "Contrôler les matériaux, les ouvrages et les solutions techniques",
          connaissances: [
            { nom: "Sciences de la construction", niveau: 4 }
          ],
          criteres: [
            "Le protocole de réalisation des essais est assuré : objectif identifié, paramètres à contrôler identifiés, protocole défini",
            "Le matériel est préparé et l'essai est réalisé",
            "Les résultats sont exploités et analysés",
            "Les caractéristiques environnementales et le bilan carbone sont analysés"
          ],
          taches: ["T4.3"]
        }
      ]
    }
  ]
};

const niveauLabels = {
  1: "Information (Notion)",
  2: "Expression (Compréhension)",
  3: "Maîtrise d'outils (Application)",
  4: "Maîtrise méthodologique (Analyse)"
};

function FormulaireBTSEBCR() {
  const [selectedBloc, setSelectedBloc] = useState(null);
  const [selectedPole, setSelectedPole] = useState(null);
  const [selectedTache, setSelectedTache] = useState(null);
  const [selectedCompetence, setSelectedCompetence] = useState(null);
  const [viewMode, setViewMode] = useState('competences');
  const [showSeanceModal, setShowSeanceModal] = useState(false);
  
  // États pour le mode édition de séance
  const [editMode, setEditMode] = useState(false);
  const [seanceNumero, setSeanceNumero] = useState('');
  const [seanceTitre, setSeanceTitre] = useState('');
  const [onDonne, setOnDonne] = useState({});
  const [onDonneDetails, setOnDonneDetails] = useState({});
  const [onDemande, setOnDemande] = useState('');
  const [customFields, setCustomFields] = useState({}); // Champs personnalisés par catégorie
  const [expandedCategories, setExpandedCategories] = useState({}); // Catégories dépliées
  const [selectedSavoirs, setSelectedSavoirs] = useState({}); // Savoirs associés sélectionnés

  const currentBloc = useMemo(() => 
    data.blocs.find(b => b.id === selectedBloc), 
    [selectedBloc]
  );

  const currentPole = useMemo(() => 
    currentBloc?.poles.find(p => p.id === selectedPole), 
    [currentBloc, selectedPole]
  );

  const currentTache = useMemo(() => 
    currentPole?.taches.find(t => t.id === selectedTache), 
    [currentPole, selectedTache]
  );

  const currentCompetence = useMemo(() => 
    currentBloc?.competences.find(c => c.id === selectedCompetence), 
    [currentBloc, selectedCompetence]
  );

  // Calcul des compétences disponibles selon la tâche sélectionnée
  const availableCompetences = useMemo(() => {
    if (!currentBloc) return [];
    
    if (selectedTache && currentTache) {
      // Si une tâche est sélectionnée, ne montrer que les compétences liées à cette tâche
      return currentBloc.competences.filter(comp => 
        currentTache.competences?.includes(comp.id)
      );
    }
    
    if (selectedPole && currentPole) {
      // Si un pôle est sélectionné, montrer les compétences liées à toutes les tâches du pôle
      const competenceIds = new Set();
      currentPole.taches.forEach(tache => {
        tache.competences?.forEach(compId => competenceIds.add(compId));
      });
      return currentBloc.competences.filter(comp => competenceIds.has(comp.id));
    }
    
    // Sinon, montrer toutes les compétences du bloc
    return currentBloc.competences;
  }, [currentBloc, currentPole, currentTache, selectedPole, selectedTache]);

  const resetFilters = () => {
    setSelectedBloc(null);
    setSelectedPole(null);
    setSelectedTache(null);
    setSelectedCompetence(null);
  };

  const handleBlocChange = (value) => {
    setSelectedBloc(value ? parseInt(value) : null);
    setSelectedPole(null);
    setSelectedTache(null);
    setSelectedCompetence(null);
  };

  const handlePoleChange = (value) => {
    setSelectedPole(value || null);
    setSelectedTache(null);
    setSelectedCompetence(null); // Réinitialiser la compétence car les options changent
  };

  const handleTacheChange = (value) => {
    setSelectedTache(value || null);
    setSelectedCompetence(null); // Réinitialiser la compétence car les options changent selon la tâche
  };

  const handleCompetenceChange = (value) => {
    setSelectedCompetence(value || null);
  };

  // Fonction pour générer et exporter le PDF en format paysage
  const exportToPDF = () => {
    const printWindow = window.open('', '_blank');
    
    // Organiser les documents cochés par catégorie
    const documentsParCategorie = {};
    Object.entries(onDonne)
      .filter(([_, checked]) => checked)
      .forEach(([key, _]) => {
        const parts = key.split('::');
        const category = parts[0];
        const isCustom = parts[1] === 'custom';
        
        if (!documentsParCategorie[category]) {
          documentsParCategorie[category] = [];
        }
        
        if (isCustom) {
          const fieldId = parseInt(parts[2]);
          const customField = (customFields[category] || []).find(f => f.id === fieldId);
          if (customField && customField.nom) {
            documentsParCategorie[category].push({
              nom: customField.nom + ' (personnalisé)',
              detail: customField.detail || ''
            });
          }
        } else {
          const itemName = parts.slice(1).join(' > ');
          documentsParCategorie[category].push({
            nom: itemName,
            detail: onDonneDetails[key] || ''
          });
        }
      });

    // Récupérer les savoirs sélectionnés
    const savoirsSelectionnes = connaissancesGlobales.filter(c => selectedSavoirs[c.id]);

    const htmlContent = `
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <title>Fiche de Séance${seanceNumero ? ' N°' + seanceNumero : ''} - BTS Bâtiment</title>
    <style>
        @page { 
            size: A4 landscape; 
            margin: 5mm;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            font-size: 7pt;
            line-height: 1.2;
            color: #1e293b;
            width: 287mm;
            height: 190mm;
            overflow: hidden;
        }
        .page-container {
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .header { 
            background: linear-gradient(135deg, #1e40af, #3b82f6);
            color: white;
            padding: 4px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
        }
        .header h1 { 
            font-size: 11pt;
            font-weight: 700;
        }
        .header-right {
            text-align: right;
            font-size: 7pt;
        }
        .header-right .seance-num {
            font-size: 9pt;
            font-weight: 700;
            background: rgba(255,255,255,0.2);
            padding: 2px 8px;
            border-radius: 3px;
        }
        .main-content {
            display: flex;
            gap: 8px;
            flex: 1;
            padding: 5px 0;
            min-height: 0;
        }
        .column {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
            overflow: hidden;
            min-height: 0;
        }
        .column-left {
            background: #f8fafc;
            border: 1px solid #3b82f6;
            border-radius: 4px;
            padding: 5px;
        }
        .column-right {
            background: #f8fafc;
            border: 1px solid #cbd5e1;
            border-radius: 4px;
            padding: 5px;
        }
        .column-title {
            font-size: 8pt;
            font-weight: 700;
            padding: 3px 6px;
            border-radius: 3px;
            text-align: center;
            flex-shrink: 0;
        }
        .column-left .column-title {
            background: #3b82f6;
            color: white;
        }
        .column-right .column-title {
            background: #64748b;
            color: white;
        }
        .section {
            margin-bottom: 3px;
            flex-shrink: 0;
        }
        .section.flex-1 {
            flex: 1;
            min-height: 0;
            display: flex;
            flex-direction: column;
        }
        .section-title {
            font-size: 6.5pt;
            font-weight: 700;
            color: white;
            padding: 2px 5px;
            border-radius: 2px;
            margin-bottom: 2px;
        }
        .section-title.blue { background: #2563eb; }
        .section-title.green { background: #16a34a; }
        .section-title.purple { background: #7c3aed; }
        .section-title.orange { background: #ea580c; }
        .section-title.red { background: #dc2626; }
        .section-title.gray { background: #64748b; }
        .section-content {
            font-size: 6.5pt;
            padding: 3px 5px;
            background: white;
            border-radius: 2px;
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }
        .section-content.scrollable {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }
        .badge {
            display: inline-block;
            padding: 0px 4px;
            border-radius: 2px;
            font-size: 6pt;
            font-weight: 600;
            margin-right: 3px;
        }
        .badge-bloc { background: #dbeafe; color: #1e40af; }
        .badge-pole { background: #dcfce7; color: #166534; }
        .badge-tache { background: #f3e8ff; color: #7c3aed; }
        .badge-comp { background: #fef3c7; color: #b45309; }
        .info-row {
            margin-bottom: 1px;
            padding: 1px 0;
            font-size: 6.5pt;
        }
        .list-compact {
            margin: 0;
            padding-left: 12px;
        }
        .list-compact li {
            margin-bottom: 1px;
            font-size: 6.5pt;
        }
        .competence-mini {
            background: #f1f5f9;
            padding: 2px 4px;
            border-radius: 2px;
            margin-bottom: 2px;
            border-left: 2px solid #3b82f6;
        }
        .competence-mini-title {
            font-weight: 600;
            color: #1e40af;
            font-size: 6.5pt;
        }
        .criteres-list {
            font-size: 6pt;
            color: #475569;
            margin-top: 1px;
        }
        .on-donne-category {
            margin-bottom: 3px;
        }
        .on-donne-category-title {
            background: #e2e8f0;
            color: #475569;
            padding: 1px 4px;
            font-weight: 600;
            font-size: 6pt;
            border-radius: 1px;
            margin-bottom: 1px;
        }
        .on-donne-item {
            padding: 1px 4px;
            background: #f8fafc;
            margin-bottom: 1px;
            border-left: 2px solid #94a3b8;
            font-size: 6.5pt;
        }
        .on-donne-detail {
            color: #64748b;
            font-style: italic;
            font-size: 6pt;
        }
        .on-demande-box {
            background: white;
            border: 1px solid #cbd5e1;
            border-radius: 2px;
            padding: 4px;
            white-space: pre-wrap;
            font-size: 7pt;
            flex: 1;
            overflow-y: auto;
        }
        .seance-header {
            background: #475569;
            color: white;
            padding: 4px 8px;
            border-radius: 3px;
            text-align: center;
            flex-shrink: 0;
        }
        .seance-header .numero {
            font-size: 9pt;
            font-weight: 700;
        }
        .seance-header .titre {
            font-size: 7pt;
            margin-top: 2px;
            font-weight: 400;
        }
        .savoir-item {
            display: inline-block;
            background: #dcfce7;
            color: #166534;
            padding: 1px 4px;
            border-radius: 2px;
            font-size: 6pt;
            margin: 1px;
        }
        .footer {
            font-size: 6pt;
            color: #94a3b8;
            text-align: center;
            padding: 2px 0;
            flex-shrink: 0;
        }
        @media print {
            body { 
                width: 287mm;
                height: 190mm;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }
        }
    </style>
</head>
<body>
    <div class="page-container">
        <div class="header">
            <div>
                <h1>📋 FICHE DE SÉANCE - BTS BÂTIMENT</h1>
            </div>
            <div class="header-right">
                ${seanceNumero ? `<span class="seance-num">Séance N° ${seanceNumero}</span>` : ''}
                <div style="margin-top: 2px; font-size: 6pt;">${new Date().toLocaleDateString('fr-FR')}</div>
            </div>
        </div>

        <div class="main-content">
            <!-- COLONNE GAUCHE : RÉFÉRENTIEL -->
            <div class="column column-left">
                <div class="column-title">📚 RÉFÉRENTIEL BTS BÂTIMENT</div>
                
                <!-- Bloc et Pôle -->
                <div class="section">
                    <div class="section-title blue">📍 Contexte</div>
                    <div class="section-content">
                        ${currentBloc ? `<div class="info-row"><span class="badge badge-bloc">${currentBloc.unite}</span> <b>Bloc ${currentBloc.id}</b> - ${currentBloc.nom}</div>` : ''}
                        ${currentPole ? `<div class="info-row"><span class="badge badge-pole">${currentPole.id}</span> ${currentPole.nom}</div>` : ''}
                        ${currentTache ? `<div class="info-row"><span class="badge badge-tache">${currentTache.id}</span> ${currentTache.nom}</div>` : ''}
                    </div>
                </div>

                <!-- Moyens et ressources -->
                ${currentPole?.conditionsExercice ? `
                <div class="section">
                    <div class="section-title green">🔧 Moyens / Ressources</div>
                    <div class="section-content">
                        <div style="font-size: 6pt;">${currentPole.conditionsExercice.moyens.slice(0, 5).join(' • ')}${currentPole.conditionsExercice.moyens.length > 5 ? ' •...' : ''}</div>
                        <div style="margin-top: 2px; font-size: 6pt;"><b>Autonomie:</b> ${currentPole.conditionsExercice.autonomie}</div>
                    </div>
                </div>
                ` : ''}

                <!-- Résultats attendus -->
                ${currentPole?.resultatsAttendus ? `
                <div class="section">
                    <div class="section-title purple">🎯 Résultats attendus</div>
                    <div class="section-content">
                        ${selectedTache && currentPole.resultatsAttendus[selectedTache] ? `
                            <ul class="list-compact">
                                ${currentPole.resultatsAttendus[selectedTache].slice(0, 3).map(r => `<li>${r}</li>`).join('')}
                            </ul>
                        ` : Object.entries(currentPole.resultatsAttendus).slice(0, 2).map(([tacheId, resultats]) => `
                            <div><b style="font-size: 6pt;">${tacheId}:</b> ${resultats.slice(0, 2).join('; ')}${resultats.length > 2 ? '...' : ''}</div>
                        `).join('')}
                    </div>
                </div>
                ` : ''}

                <!-- Compétences mobilisées -->
                <div class="section">
                    <div class="section-title orange">⚡ Compétences</div>
                    <div class="section-content">
                        ${availableCompetences.slice(0, 3).map(comp => `
                            <div class="competence-mini">
                                <div class="competence-mini-title">${comp.id} - ${comp.nom}</div>
                                <div style="font-size: 6pt; color: #64748b;">${comp.connaissances.slice(0, 3).map(c => `${c.nom}(N${c.niveau})`).join(', ')}</div>
                                <div class="criteres-list">${comp.criteres.slice(0, 2).join(' • ')}</div>
                            </div>
                        `).join('')}
                        ${availableCompetences.length > 3 ? `<div style="font-size: 6pt; color: #94a3b8;">+ ${availableCompetences.length - 3} autres compétences...</div>` : ''}
                    </div>
                </div>

                <!-- Savoirs associés -->
                ${savoirsSelectionnes.length > 0 ? `
                <div class="section">
                    <div class="section-title red">📚 Savoirs</div>
                    <div class="section-content">
                        ${savoirsSelectionnes.map(s => `<span class="savoir-item">${s.id}. ${s.nom}</span>`).join('')}
                    </div>
                </div>
                ` : ''}
            </div>

            <!-- COLONNE DROITE : CONSTRUCTION DE LA SÉANCE -->
            <div class="column column-right">
                <div class="column-title">✏️ CONSTRUCTION DE LA SÉANCE</div>
                
                <!-- En-tête séance -->
                <div class="seance-header">
                    ${seanceNumero ? `<div class="numero">SÉANCE N° ${seanceNumero}</div>` : '<div class="numero">SÉANCE</div>'}
                    ${seanceTitre ? `<div class="titre">${seanceTitre}</div>` : ''}
                </div>

                <!-- ON DONNE -->
                <div class="section flex-1">
                    <div class="section-title gray">📄 ON DONNE</div>
                    <div class="section-content scrollable">
                        ${Object.keys(documentsParCategorie).length > 0 ? 
                          Object.entries(documentsParCategorie).map(([category, docs]) => `
                            <div class="on-donne-category">
                                <div class="on-donne-category-title">${category}</div>
                                ${docs.map(doc => `
                                    <div class="on-donne-item">
                                        ✓ ${doc.nom}${doc.detail ? ` <span class="on-donne-detail">— ${doc.detail}</span>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                          `).join('') 
                        : '<p style="color: #94a3b8; font-style: italic; font-size: 6pt;">Aucun document</p>'}
                    </div>
                </div>

                <!-- ON DEMANDE -->
                <div class="section flex-1">
                    <div class="section-title gray">❓ ON DEMANDE</div>
                    <div class="on-demande-box">
                        ${onDemande || '<span style="color: #94a3b8; font-style: italic;">Travail à réaliser...</span>'}
                    </div>
                </div>
            </div>
        </div>

        <div class="footer">
            BTS Bâtiment - Fiche de séance - ${new Date().toLocaleDateString('fr-FR')}
        </div>
    </div>
</body>
</html>
    `;

    printWindow.document.write(htmlContent);
    printWindow.document.close();
    printWindow.onload = () => {
      printWindow.print();
    };
  };

  // Toggle un moyen dans "On donne"
  const toggleOnDonne = (moyen) => {
    setOnDonne(prev => ({
      ...prev,
      [moyen]: !prev[moyen]
    }));
  };

  // Mettre à jour le détail d'un moyen
  const updateOnDonneDetail = (moyen, detail) => {
    setOnDonneDetails(prev => ({
      ...prev,
      [moyen]: detail
    }));
  };

  // Toggle une catégorie (déplier/replier)
  const toggleCategory = (category) => {
    setExpandedCategories(prev => ({
      ...prev,
      [category]: !prev[category]
    }));
  };

  // Ajouter un champ personnalisé à une catégorie
  const addCustomField = (category) => {
    const newField = { id: Date.now(), nom: '', detail: '' };
    setCustomFields(prev => ({
      ...prev,
      [category]: [...(prev[category] || []), newField]
    }));
  };

  // Mettre à jour un champ personnalisé
  const updateCustomField = (category, fieldId, key, value) => {
    setCustomFields(prev => ({
      ...prev,
      [category]: (prev[category] || []).map(field => 
        field.id === fieldId ? { ...field, [key]: value } : field
      )
    }));
  };

  // Supprimer un champ personnalisé
  const removeCustomField = (category, fieldId) => {
    setCustomFields(prev => ({
      ...prev,
      [category]: (prev[category] || []).filter(field => field.id !== fieldId)
    }));
  };

  // Fonction pour rendre les items d'une catégorie (récursif pour sous-catégories)
  const renderCategoryItems = (items, categoryPath) => {
    if (Array.isArray(items)) {
      return items.map((item, idx) => {
        const itemKey = `${categoryPath}::${item}`;
        return (
          <div key={idx} style={{ marginBottom: '10px' }}>
            <label style={{ 
              display: 'flex', 
              alignItems: 'flex-start', 
              gap: '10px',
              cursor: 'pointer',
              padding: '8px',
              borderRadius: '6px',
              background: onDonne[itemKey] ? 'rgba(96, 165, 250, 0.1)' : 'transparent',
              border: onDonne[itemKey] ? '1px solid rgba(96, 165, 250, 0.3)' : '1px solid transparent',
              transition: 'all 0.2s ease'
            }}>
              <input
                type="checkbox"
                checked={onDonne[itemKey] || false}
                onChange={() => toggleOnDonne(itemKey)}
                style={{ 
                  width: '18px', 
                  height: '18px', 
                  marginTop: '2px',
                  accentColor: '#60a5fa'
                }}
              />
              <span style={{ color: '#e2e8f0', fontSize: '13px' }}>{item}</span>
            </label>
            {onDonne[itemKey] && (
              <input
                type="text"
                value={onDonneDetails[itemKey] || ''}
                onChange={(e) => updateOnDonneDetail(itemKey, e.target.value)}
                placeholder="Précisions (ex: pages 1-5, version du 12/01...)"
                style={{
                  width: 'calc(100% - 28px)',
                  marginLeft: '28px',
                  marginTop: '6px',
                  padding: '8px 12px',
                  background: 'rgba(30, 41, 59, 0.8)',
                  border: '1px solid rgba(96, 165, 250, 0.3)',
                  borderRadius: '6px',
                  color: '#e2e8f0',
                  fontSize: '12px'
                }}
              />
            )}
          </div>
        );
      });
    } else if (typeof items === 'object') {
      // Sous-catégories
      return Object.entries(items).map(([subCat, subItems]) => (
        <div key={subCat} style={{ 
          marginBottom: '12px',
          marginLeft: '12px',
          paddingLeft: '12px',
          borderLeft: '2px solid rgba(148, 163, 184, 0.2)'
        }}>
          <div style={{ 
            color: '#94a3b8', 
            fontSize: '12px', 
            fontWeight: 600,
            marginBottom: '8px',
            textTransform: 'uppercase',
            letterSpacing: '0.5px'
          }}>
            {subCat}
          </div>
          {renderCategoryItems(subItems, `${categoryPath}::${subCat}`)}
        </div>
      ));
    }
    return null;
  };

  return (
    <div style={{
      minHeight: '100vh',
      background: 'linear-gradient(135deg, #0f172a 0%, #1e293b 50%, #0f172a 100%)',
      fontFamily: "'Instrument Sans', 'SF Pro Display', -apple-system, sans-serif",
      color: '#e2e8f0',
      padding: '2rem'
    }}>
      <style>{`
        @import url('https://fonts.googleapis.com/css2?family=Instrument+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap');
        
        * { box-sizing: border-box; }
        
        .glass-card {
          background: rgba(30, 41, 59, 0.6);
          backdrop-filter: blur(20px);
          border: 1px solid rgba(148, 163, 184, 0.1);
          border-radius: 20px;
          transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .glass-card:hover {
          border-color: rgba(251, 191, 36, 0.3);
          box-shadow: 0 0 40px rgba(251, 191, 36, 0.1);
        }
        
        .select-wrapper {
          position: relative;
        }
        
        .select-wrapper::after {
          content: '▼';
          position: absolute;
          right: 16px;
          top: 50%;
          transform: translateY(-50%);
          color: #fbbf24;
          font-size: 10px;
          pointer-events: none;
        }
        
        select {
          appearance: none;
          width: 100%;
          padding: 14px 40px 14px 16px;
          background: rgba(15, 23, 42, 0.8);
          border: 2px solid rgba(148, 163, 184, 0.2);
          border-radius: 12px;
          color: #e2e8f0;
          font-size: 14px;
          font-family: inherit;
          cursor: pointer;
          transition: all 0.2s ease;
        }
        
        select:hover {
          border-color: rgba(251, 191, 36, 0.5);
        }
        
        select:focus {
          outline: none;
          border-color: #fbbf24;
          box-shadow: 0 0 0 3px rgba(251, 191, 36, 0.2);
        }
        
        select option {
          background: #1e293b;
          color: #e2e8f0;
          padding: 12px;
        }
        
        .tag {
          display: inline-flex;
          align-items: center;
          padding: 6px 12px;
          border-radius: 20px;
          font-size: 12px;
          font-weight: 600;
          font-family: 'JetBrains Mono', monospace;
          letter-spacing: 0.5px;
        }
        
        .niveau-1 { background: rgba(34, 197, 94, 0.2); color: #4ade80; border: 1px solid rgba(34, 197, 94, 0.3); }
        .niveau-2 { background: rgba(59, 130, 246, 0.2); color: #60a5fa; border: 1px solid rgba(59, 130, 246, 0.3); }
        .niveau-3 { background: rgba(168, 85, 247, 0.2); color: #c084fc; border: 1px solid rgba(168, 85, 247, 0.3); }
        .niveau-4 { background: rgba(251, 191, 36, 0.2); color: #fbbf24; border: 1px solid rgba(251, 191, 36, 0.3); }
        
        .btn-mode {
          padding: 10px 20px;
          border: 2px solid transparent;
          border-radius: 10px;
          font-size: 13px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s ease;
          background: rgba(30, 41, 59, 0.6);
          color: #94a3b8;
        }
        
        .btn-mode:hover {
          background: rgba(30, 41, 59, 0.9);
          color: #e2e8f0;
        }
        
        .btn-mode.active {
          background: linear-gradient(135deg, #fbbf24, #f59e0b);
          color: #0f172a;
          border-color: #fbbf24;
        }
        
        .btn-reset {
          padding: 12px 24px;
          background: transparent;
          border: 2px solid rgba(239, 68, 68, 0.5);
          border-radius: 10px;
          color: #ef4444;
          font-size: 13px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.2s ease;
        }
        
        .btn-reset:hover {
          background: rgba(239, 68, 68, 0.1);
          border-color: #ef4444;
        }
        
        .result-card {
          background: rgba(15, 23, 42, 0.6);
          border: 1px solid rgba(148, 163, 184, 0.1);
          border-radius: 16px;
          padding: 20px;
          margin-bottom: 16px;
          transition: all 0.2s ease;
        }
        
        .result-card:hover {
          transform: translateX(8px);
          border-color: rgba(251, 191, 36, 0.3);
        }
        
        .critere-item {
          display: flex;
          align-items: flex-start;
          gap: 12px;
          padding: 12px 16px;
          background: rgba(30, 41, 59, 0.4);
          border-radius: 10px;
          margin-bottom: 8px;
          border-left: 3px solid #fbbf24;
        }
        
        .critere-check {
          width: 20px;
          height: 20px;
          border-radius: 50%;
          background: linear-gradient(135deg, #fbbf24, #f59e0b);
          display: flex;
          align-items: center;
          justify-content: center;
          flex-shrink: 0;
          margin-top: 2px;
        }
        
        .animate-in {
          animation: slideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes slideIn {
          from {
            opacity: 0;
            transform: translateY(20px);
          }
          to {
            opacity: 1;
            transform: translateY(0);
          }
        }
        
        .header-decoration {
          position: absolute;
          top: -2px;
          left: 50%;
          transform: translateX(-50%);
          width: 100px;
          height: 4px;
          background: linear-gradient(90deg, transparent, #fbbf24, transparent);
          border-radius: 2px;
        }
        
        .glow-text {
          text-shadow: 0 0 40px rgba(251, 191, 36, 0.3);
        }

        .empty-state {
          text-align: center;
          padding: 60px 20px;
          color: #64748b;
        }
        
        .empty-state svg {
          width: 80px;
          height: 80px;
          margin-bottom: 20px;
          opacity: 0.5;
        }
      `}</style>

      <div style={{ maxWidth: '1200px', margin: '0 auto' }}>
        {/* Header */}
        <div className="glass-card" style={{ 
          padding: '40px', 
          marginBottom: '24px',
          position: 'relative',
          overflow: 'hidden'
        }}>
          <div className="header-decoration" />
          <div style={{ 
            position: 'absolute',
            top: 0,
            right: 0,
            width: '300px',
            height: '300px',
            background: 'radial-gradient(circle, rgba(251, 191, 36, 0.1) 0%, transparent 70%)',
            pointerEvents: 'none'
          }} />
          
          <h1 className="glow-text" style={{ 
            fontSize: '2.5rem', 
            fontWeight: 700, 
            marginBottom: '12px',
            background: 'linear-gradient(135deg, #fbbf24, #f59e0b, #fbbf24)',
            WebkitBackgroundClip: 'text',
            WebkitTextFillColor: 'transparent',
            letterSpacing: '-0.5px'
          }}>
            Référentiel BTS Bâtiment
          </h1>
          <p style={{ 
            color: '#94a3b8', 
            fontSize: '1.1rem',
            maxWidth: '600px'
          }}>
            Explorateur interactif du référentiel de compétences
            <span style={{ 
              display: 'inline-block',
              marginLeft: '12px',
              padding: '4px 10px',
              background: 'rgba(251, 191, 36, 0.15)',
              borderRadius: '6px',
              fontSize: '12px',
              color: '#fbbf24',
              fontFamily: "'JetBrains Mono', monospace"
            }}>
              4 Blocs • 15 Compétences
            </span>
          </p>
          <p style={{
            position: 'absolute',
            bottom: '16px',
            right: '24px',
            fontSize: '11px',
            fontStyle: 'italic',
            color: '#64748b',
            margin: 0
          }}>
            Jean-Philippe Amat — V1.2 — 2026
          </p>
        </div>

        {/* Mode Toggle & Reset */}
        <div style={{ 
          display: 'flex', 
          justifyContent: 'space-between', 
          alignItems: 'center',
          marginBottom: '24px',
          flexWrap: 'wrap',
          gap: '16px'
        }}>
          <div style={{ display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
            <button 
              className={`btn-mode ${viewMode === 'competences' ? 'active' : ''}`}
              onClick={() => setViewMode('competences')}
            >
              ◇ Bloc de compétences
            </button>
            <button 
              className={`btn-mode ${viewMode === 'tableau' ? 'active' : ''}`}
              onClick={() => setViewMode('tableau')}
            >
              ▦ Tâches / Compétences
            </button>
            <button 
              className={`btn-mode ${viewMode === 'connaissances' ? 'active' : ''}`}
              onClick={() => setViewMode('connaissances')}
            >
              ▤ Connaissances / Compétences
            </button>
          </div>
          
          <button className="btn-reset" onClick={resetFilters}>
            ↺ Réinitialiser les filtres
          </button>
        </div>

        {/* Filters */}
        <div className="glass-card animate-in" style={{ padding: '32px', marginBottom: '24px' }}>
          <h2 style={{ 
            fontSize: '1rem', 
            fontWeight: 600, 
            marginBottom: '24px',
            color: '#fbbf24',
            textTransform: 'uppercase',
            letterSpacing: '2px',
            display: 'flex',
            alignItems: 'center',
            gap: '10px'
          }}>
            <span style={{ 
              width: '8px', 
              height: '8px', 
              background: '#fbbf24', 
              borderRadius: '2px' 
            }} />
            Filtres conditionnels
          </h2>
          
          <div style={{ 
            display: 'grid', 
            gridTemplateColumns: 'repeat(auto-fit, minmax(280px, 1fr))', 
            gap: '20px' 
          }}>
            {/* Bloc Filter */}
            <div>
              <label style={{ 
                display: 'block', 
                marginBottom: '8px', 
                color: '#94a3b8',
                fontSize: '13px',
                fontWeight: 500
              }}>
                Bloc de compétences
              </label>
              <div className="select-wrapper">
                <select value={selectedBloc || ''} onChange={(e) => handleBlocChange(e.target.value)}>
                  <option value="">Tous les blocs</option>
                  {data.blocs.map(bloc => (
                    <option key={bloc.id} value={bloc.id}>
                      Bloc {bloc.id} ({bloc.unite}) — {bloc.nom}
                    </option>
                  ))}
                </select>
              </div>
            </div>

            {/* Pole Filter - Conditional */}
            {selectedBloc && (
              <div className="animate-in">
                <label style={{ 
                  display: 'block', 
                  marginBottom: '8px', 
                  color: '#94a3b8',
                  fontSize: '13px',
                  fontWeight: 500
                }}>
                  Pôle d'activité
                </label>
                <div className="select-wrapper">
                  <select value={selectedPole || ''} onChange={(e) => handlePoleChange(e.target.value)}>
                    <option value="">Tous les pôles</option>
                    {currentBloc?.poles.map(pole => (
                      <option key={pole.id} value={pole.id}>
                        {pole.id} — {pole.nom}
                      </option>
                    ))}
                  </select>
                </div>
              </div>
            )}

            {/* Tache Filter - Conditional */}
            {selectedPole && (
              <div className="animate-in">
                <label style={{ 
                  display: 'block', 
                  marginBottom: '8px', 
                  color: '#94a3b8',
                  fontSize: '13px',
                  fontWeight: 500
                }}>
                  Tâche professionnelle
                </label>
                <div className="select-wrapper">
                  <select value={selectedTache || ''} onChange={(e) => handleTacheChange(e.target.value)}>
                    <option value="">Toutes les tâches</option>
                    {currentPole?.taches.map(tache => (
                      <option key={tache.id} value={tache.id}>
                        {tache.id} — {tache.nom}
                      </option>
                    ))}
                  </select>
                </div>
              </div>
            )}

            {/* Competence Filter - Conditional based on task selection */}
            {selectedBloc && (
              <div className="animate-in">
                <label style={{ 
                  display: 'block', 
                  marginBottom: '8px', 
                  color: '#94a3b8',
                  fontSize: '13px',
                  fontWeight: 500
                }}>
                  Compétence
                  {selectedTache && (
                    <span style={{ 
                      marginLeft: '8px',
                      fontSize: '11px',
                      color: '#fbbf24',
                      fontStyle: 'italic'
                    }}>
                      (filtrée selon {selectedTache})
                    </span>
                  )}
                </label>
                <div className="select-wrapper">
                  <select value={selectedCompetence || ''} onChange={(e) => handleCompetenceChange(e.target.value)}>
                    <option value="">{selectedTache ? `Compétences de ${selectedTache}` : 'Toutes les compétences'}</option>
                    {availableCompetences.map(comp => (
                      <option key={comp.id} value={comp.id}>
                        {comp.id} — {comp.nom}
                      </option>
                    ))}
                  </select>
                </div>
              </div>
            )}
          </div>

          {/* Bouton Aide à la création de séance */}
          {selectedBloc && (
            <div style={{ marginTop: '24px', paddingTop: '24px', borderTop: '1px solid rgba(148, 163, 184, 0.2)' }}>
              <button
                onClick={() => setShowSeanceModal(true)}
                style={{
                  width: '100%',
                  padding: '16px 24px',
                  background: 'linear-gradient(135deg, #10b981, #059669)',
                  border: 'none',
                  borderRadius: '12px',
                  color: '#fff',
                  fontSize: '15px',
                  fontWeight: 600,
                  cursor: 'pointer',
                  display: 'flex',
                  alignItems: 'center',
                  justifyContent: 'center',
                  gap: '10px',
                  transition: 'all 0.2s ease',
                  boxShadow: '0 4px 20px rgba(16, 185, 129, 0.3)'
                }}
                onMouseOver={(e) => e.target.style.transform = 'translateY(-2px)'}
                onMouseOut={(e) => e.target.style.transform = 'translateY(0)'}
              >
                <span style={{ fontSize: '20px' }}>📋</span>
                Aide à la création de séance
              </button>
            </div>
          )}
        </div>

        {/* Modal Aide à la création de séance */}
        {showSeanceModal && (
          <div style={{
            position: 'fixed',
            top: 0,
            left: 0,
            right: 0,
            bottom: 0,
            background: 'rgba(0, 0, 0, 0.8)',
            backdropFilter: 'blur(8px)',
            zIndex: 1000,
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            padding: '20px'
          }} onClick={() => setShowSeanceModal(false)}>
            <div 
              className="glass-card animate-in"
              style={{
                maxWidth: '900px',
                maxHeight: '90vh',
                overflow: 'auto',
                padding: '32px',
                position: 'relative'
              }}
              onClick={(e) => e.stopPropagation()}
            >
              {/* Header Modal */}
              <div style={{ 
                display: 'flex', 
                justifyContent: 'space-between', 
                alignItems: 'flex-start',
                marginBottom: '24px'
              }}>
                <div>
                  <h2 style={{ 
                    fontSize: '1.5rem', 
                    fontWeight: 700, 
                    color: '#10b981',
                    marginBottom: '8px'
                  }}>
                    📋 Aide à la création de séance
                  </h2>
                  <p style={{ color: '#94a3b8', fontSize: '14px' }}>
                    Récapitulatif des éléments selon vos choix de filtrage
                  </p>
                </div>
                <button
                  onClick={() => setShowSeanceModal(false)}
                  style={{
                    background: 'rgba(239, 68, 68, 0.2)',
                    border: '1px solid rgba(239, 68, 68, 0.3)',
                    borderRadius: '8px',
                    color: '#ef4444',
                    padding: '8px 12px',
                    cursor: 'pointer',
                    fontSize: '14px'
                  }}
                >
                  ✕ Fermer
                </button>
              </div>

              {/* Contexte sélectionné */}
              <div style={{
                background: 'rgba(251, 191, 36, 0.1)',
                borderRadius: '12px',
                padding: '16px',
                marginBottom: '24px',
                borderLeft: '4px solid #fbbf24'
              }}>
                <h3 style={{ color: '#fbbf24', fontSize: '14px', fontWeight: 600, marginBottom: '12px', textTransform: 'uppercase', letterSpacing: '1px' }}>
                  Contexte sélectionné
                </h3>
                <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
                  {currentBloc && (
                    <span className="tag niveau-4">Bloc {currentBloc.id} - {currentBloc.nom}</span>
                  )}
                  {currentPole && (
                    <span className="tag niveau-3">{currentPole.id} - {currentPole.nom}</span>
                  )}
                  {currentTache && (
                    <span className="tag niveau-2">{currentTache.id}</span>
                  )}
                  {currentCompetence && (
                    <span className="tag niveau-1">{currentCompetence.id}</span>
                  )}
                </div>
              </div>

              {/* Conditions d'exercice */}
              {currentPole?.conditionsExercice && (
                <div style={{ marginBottom: '24px' }}>
                  <h3 style={{ 
                    color: '#60a5fa', 
                    fontSize: '14px', 
                    fontWeight: 600, 
                    marginBottom: '16px',
                    textTransform: 'uppercase',
                    letterSpacing: '1px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px'
                  }}>
                    <span>🔧</span> Moyens et ressources
                  </h3>
                  <div style={{
                    background: 'rgba(96, 165, 250, 0.1)',
                    borderRadius: '12px',
                    padding: '16px'
                  }}>
                    <ul style={{ margin: 0, paddingLeft: '20px' }}>
                      {currentPole.conditionsExercice.moyens.map((moyen, idx) => (
                        <li key={idx} style={{ color: '#e2e8f0', marginBottom: '8px', fontSize: '14px' }}>
                          {moyen}
                        </li>
                      ))}
                    </ul>
                    <div style={{ 
                      marginTop: '16px', 
                      paddingTop: '12px', 
                      borderTop: '1px solid rgba(96, 165, 250, 0.2)',
                      display: 'flex',
                      alignItems: 'center',
                      gap: '8px'
                    }}>
                      <span style={{ color: '#94a3b8', fontSize: '13px' }}>Autonomie :</span>
                      <span style={{
                        background: currentPole.conditionsExercice.autonomie === 'Totale sur des ouvrages courants' 
                          ? 'rgba(34, 197, 94, 0.2)' 
                          : 'rgba(251, 191, 36, 0.2)',
                        color: currentPole.conditionsExercice.autonomie === 'Totale sur des ouvrages courants'
                          ? '#4ade80'
                          : '#fbbf24',
                        padding: '4px 10px',
                        borderRadius: '6px',
                        fontSize: '12px',
                        fontWeight: 600
                      }}>
                        {currentPole.conditionsExercice.autonomie}
                      </span>
                    </div>
                  </div>
                </div>
              )}

              {/* Résultats attendus */}
              {currentPole?.resultatsAttendus && (
                <div style={{ marginBottom: '24px' }}>
                  <h3 style={{ 
                    color: '#c084fc', 
                    fontSize: '14px', 
                    fontWeight: 600, 
                    marginBottom: '16px',
                    textTransform: 'uppercase',
                    letterSpacing: '1px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px'
                  }}>
                    <span>🎯</span> Résultats attendus
                  </h3>
                  <div style={{
                    background: 'rgba(192, 132, 252, 0.1)',
                    borderRadius: '12px',
                    padding: '16px'
                  }}>
                    {/* Si une tâche est sélectionnée, afficher seulement ses résultats */}
                    {selectedTache && currentPole.resultatsAttendus[selectedTache] ? (
                      <div>
                        <div style={{
                          display: 'flex',
                          alignItems: 'center',
                          gap: '8px',
                          marginBottom: '12px',
                          paddingBottom: '8px',
                          borderBottom: '1px solid rgba(192, 132, 252, 0.2)'
                        }}>
                          <span style={{
                            background: 'rgba(192, 132, 252, 0.3)',
                            color: '#c084fc',
                            padding: '2px 8px',
                            borderRadius: '4px',
                            fontSize: '11px',
                            fontWeight: 600
                          }}>{selectedTache}</span>
                          <span style={{ color: '#94a3b8', fontSize: '12px' }}>
                            {currentTache?.nom}
                          </span>
                        </div>
                        {currentPole.resultatsAttendus[selectedTache].map((resultat, idx) => (
                          <div key={idx} style={{ 
                            display: 'flex', 
                            alignItems: 'flex-start', 
                            gap: '10px',
                            marginBottom: '10px'
                          }}>
                            <span style={{
                              width: '20px',
                              height: '20px',
                              background: 'rgba(192, 132, 252, 0.3)',
                              borderRadius: '50%',
                              display: 'flex',
                              alignItems: 'center',
                              justifyContent: 'center',
                              fontSize: '10px',
                              color: '#c084fc',
                              flexShrink: 0
                            }}>✓</span>
                            <span style={{ color: '#e2e8f0', fontSize: '14px' }}>{resultat}</span>
                          </div>
                        ))}
                      </div>
                    ) : (
                      /* Sinon afficher tous les résultats groupés par tâche */
                      Object.entries(currentPole.resultatsAttendus).map(([tacheId, resultats]) => (
                        <div key={tacheId} style={{ marginBottom: '16px' }}>
                          <div style={{
                            display: 'flex',
                            alignItems: 'center',
                            gap: '8px',
                            marginBottom: '10px',
                            paddingBottom: '6px',
                            borderBottom: '1px solid rgba(192, 132, 252, 0.2)'
                          }}>
                            <span style={{
                              background: 'rgba(192, 132, 252, 0.3)',
                              color: '#c084fc',
                              padding: '2px 8px',
                              borderRadius: '4px',
                              fontSize: '11px',
                              fontWeight: 600
                            }}>{tacheId}</span>
                            <span style={{ color: '#94a3b8', fontSize: '12px' }}>
                              {currentPole.taches.find(t => t.id === tacheId)?.nom}
                            </span>
                          </div>
                          {resultats.map((resultat, idx) => (
                            <div key={idx} style={{ 
                              display: 'flex', 
                              alignItems: 'flex-start', 
                              gap: '10px',
                              marginBottom: '8px',
                              marginLeft: '8px'
                            }}>
                              <span style={{
                                width: '16px',
                                height: '16px',
                                background: 'rgba(192, 132, 252, 0.2)',
                                borderRadius: '50%',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '8px',
                                color: '#c084fc',
                                flexShrink: 0
                              }}>✓</span>
                              <span style={{ color: '#e2e8f0', fontSize: '13px' }}>{resultat}</span>
                            </div>
                          ))}
                        </div>
                      ))
                    )}
                  </div>
                </div>
              )}

              {/* Compétences mobilisées */}
              {availableCompetences.length > 0 && (
                <div style={{ marginBottom: '24px' }}>
                  <h3 style={{ 
                    color: '#fbbf24', 
                    fontSize: '14px', 
                    fontWeight: 600, 
                    marginBottom: '16px',
                    textTransform: 'uppercase',
                    letterSpacing: '1px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px'
                  }}>
                    <span>⚡</span> Compétences mobilisées
                  </h3>
                  {availableCompetences.map(comp => (
                    <div key={comp.id} style={{
                      background: 'rgba(251, 191, 36, 0.1)',
                      borderRadius: '12px',
                      padding: '16px',
                      marginBottom: '12px'
                    }}>
                      <div style={{ 
                        display: 'flex', 
                        alignItems: 'center', 
                        gap: '10px',
                        marginBottom: '12px'
                      }}>
                        <span style={{
                          background: 'linear-gradient(135deg, #fbbf24, #f59e0b)',
                          color: '#0f172a',
                          padding: '4px 10px',
                          borderRadius: '6px',
                          fontWeight: 700,
                          fontSize: '12px'
                        }}>{comp.id}</span>
                        <span style={{ color: '#e2e8f0', fontWeight: 500 }}>{comp.nom}</span>
                      </div>

                      {/* Connaissances associées */}
                      <div style={{ marginBottom: '12px' }}>
                        <span style={{ color: '#94a3b8', fontSize: '12px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                          Connaissances associées :
                        </span>
                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '6px', marginTop: '8px' }}>
                          {comp.connaissances.map((conn, idx) => (
                            <span key={idx} style={{
                              background: 'rgba(30, 41, 59, 0.6)',
                              padding: '4px 10px',
                              borderRadius: '6px',
                              fontSize: '12px',
                              color: '#e2e8f0',
                              display: 'flex',
                              alignItems: 'center',
                              gap: '6px'
                            }}>
                              {conn.nom}
                              <span className={`tag niveau-${conn.niveau}`} style={{ padding: '2px 6px', fontSize: '10px' }}>
                                N{conn.niveau}
                              </span>
                            </span>
                          ))}
                        </div>
                      </div>

                      {/* Critères d'évaluation */}
                      <div>
                        <span style={{ color: '#94a3b8', fontSize: '12px', textTransform: 'uppercase', letterSpacing: '0.5px' }}>
                          Critères d'évaluation :
                        </span>
                        <ul style={{ margin: '8px 0 0 0', paddingLeft: '20px' }}>
                          {comp.criteres.map((critere, idx) => (
                            <li key={idx} style={{ color: '#94a3b8', fontSize: '13px', marginBottom: '4px' }}>
                              {critere}
                            </li>
                          ))}
                        </ul>
                      </div>
                    </div>
                  ))}
                </div>
              )}

              {/* Mode Édition - Fiche de séance */}
              <div style={{ 
                marginBottom: '24px',
                padding: '20px',
                background: 'rgba(16, 185, 129, 0.1)',
                borderRadius: '12px',
                border: '1px solid rgba(16, 185, 129, 0.3)'
              }}>
                <div style={{ 
                  display: 'flex', 
                  justifyContent: 'space-between', 
                  alignItems: 'center',
                  marginBottom: '16px'
                }}>
                  <h3 style={{ 
                    color: '#10b981', 
                    fontSize: '14px', 
                    fontWeight: 600,
                    textTransform: 'uppercase',
                    letterSpacing: '1px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px'
                  }}>
                    <span>✏️</span> Mode Édition - Fiche de séance
                  </h3>
                  <button
                    onClick={() => setEditMode(!editMode)}
                    style={{
                      background: editMode ? 'rgba(239, 68, 68, 0.2)' : 'rgba(16, 185, 129, 0.2)',
                      border: `1px solid ${editMode ? 'rgba(239, 68, 68, 0.3)' : 'rgba(16, 185, 129, 0.3)'}`,
                      borderRadius: '8px',
                      color: editMode ? '#ef4444' : '#10b981',
                      padding: '8px 16px',
                      cursor: 'pointer',
                      fontSize: '13px',
                      fontWeight: 600
                    }}
                  >
                    {editMode ? '✕ Fermer l\'édition' : '✎ Ouvrir l\'édition'}
                  </button>
                </div>

                {editMode && (
                  <div>
                    {/* Numéro et Titre de la séance */}
                    <div style={{ 
                      display: 'grid', 
                      gridTemplateColumns: '150px 1fr', 
                      gap: '16px',
                      marginBottom: '20px'
                    }}>
                      <div>
                        <label style={{ 
                          display: 'block', 
                          color: '#94a3b8', 
                          fontSize: '12px', 
                          marginBottom: '6px',
                          textTransform: 'uppercase',
                          letterSpacing: '0.5px'
                        }}>N° Séance</label>
                        <input
                          type="text"
                          value={seanceNumero}
                          onChange={(e) => setSeanceNumero(e.target.value)}
                          placeholder="Ex: 1, 2.1..."
                          style={{
                            width: '100%',
                            padding: '10px 12px',
                            background: 'rgba(30, 41, 59, 0.8)',
                            border: '1px solid rgba(148, 163, 184, 0.2)',
                            borderRadius: '8px',
                            color: '#e2e8f0',
                            fontSize: '14px'
                          }}
                        />
                      </div>
                      <div>
                        <label style={{ 
                          display: 'block', 
                          color: '#94a3b8', 
                          fontSize: '12px', 
                          marginBottom: '6px',
                          textTransform: 'uppercase',
                          letterSpacing: '0.5px'
                        }}>Titre de la séance</label>
                        <input
                          type="text"
                          value={seanceTitre}
                          onChange={(e) => setSeanceTitre(e.target.value)}
                          placeholder="Ex: Analyse d'un dossier de consultation..."
                          style={{
                            width: '100%',
                            padding: '10px 12px',
                            background: 'rgba(30, 41, 59, 0.8)',
                            border: '1px solid rgba(148, 163, 184, 0.2)',
                            borderRadius: '8px',
                            color: '#e2e8f0',
                            fontSize: '14px'
                          }}
                        />
                      </div>
                    </div>

                    {/* ON DONNE - Ressources documentaires */}
                    <div style={{ marginBottom: '20px' }}>
                      <h4 style={{ 
                        color: '#60a5fa', 
                        fontSize: '13px', 
                        fontWeight: 600, 
                        marginBottom: '12px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                      }}>
                        <span>📄</span> ON DONNE (cocher les documents fournis)
                      </h4>
                      <div style={{
                        background: 'rgba(30, 41, 59, 0.5)',
                        borderRadius: '8px',
                        padding: '12px',
                        maxHeight: '500px',
                        overflowY: 'auto'
                      }}>
                        {Object.entries(ressourcesDocumentaires).map(([category, items]) => (
                          <div key={category} style={{ 
                            marginBottom: '12px',
                            border: '1px solid rgba(148, 163, 184, 0.2)',
                            borderRadius: '8px',
                            overflow: 'hidden'
                          }}>
                            {/* En-tête de catégorie */}
                            <div 
                              onClick={() => toggleCategory(category)}
                              style={{ 
                                display: 'flex',
                                justifyContent: 'space-between',
                                alignItems: 'center',
                                padding: '10px 12px',
                                background: 'rgba(96, 165, 250, 0.15)',
                                cursor: 'pointer',
                                userSelect: 'none'
                              }}
                            >
                              <span style={{ 
                                color: '#60a5fa', 
                                fontWeight: 600, 
                                fontSize: '12px'
                              }}>
                                {expandedCategories[category] ? '▼' : '▶'} {category}
                              </span>
                              <span style={{
                                color: '#94a3b8',
                                fontSize: '11px'
                              }}>
                                {Object.entries(onDonne).filter(([k, v]) => k.startsWith(category) && v).length} sélectionné(s)
                              </span>
                            </div>
                            
                            {/* Contenu de la catégorie */}
                            {expandedCategories[category] && (
                              <div style={{ padding: '12px' }}>
                                {renderCategoryItems(items, category)}
                                
                                {/* Champs personnalisés */}
                                {(customFields[category] || []).map(field => (
                                  <div key={field.id} style={{ 
                                    marginBottom: '10px',
                                    padding: '10px',
                                    background: 'rgba(16, 185, 129, 0.1)',
                                    borderRadius: '6px',
                                    border: '1px solid rgba(16, 185, 129, 0.3)'
                                  }}>
                                    <div style={{ display: 'flex', gap: '8px', alignItems: 'center', marginBottom: '8px' }}>
                                      <input
                                        type="checkbox"
                                        checked={onDonne[`${category}::custom::${field.id}`] || false}
                                        onChange={() => toggleOnDonne(`${category}::custom::${field.id}`)}
                                        style={{ width: '16px', height: '16px', accentColor: '#10b981' }}
                                      />
                                      <input
                                        type="text"
                                        value={field.nom}
                                        onChange={(e) => updateCustomField(category, field.id, 'nom', e.target.value)}
                                        placeholder="Nom du document personnalisé..."
                                        style={{
                                          flex: 1,
                                          padding: '6px 10px',
                                          background: 'rgba(30, 41, 59, 0.8)',
                                          border: '1px solid rgba(16, 185, 129, 0.3)',
                                          borderRadius: '4px',
                                          color: '#e2e8f0',
                                          fontSize: '12px'
                                        }}
                                      />
                                      <button
                                        onClick={() => removeCustomField(category, field.id)}
                                        style={{
                                          background: 'rgba(239, 68, 68, 0.2)',
                                          border: '1px solid rgba(239, 68, 68, 0.3)',
                                          borderRadius: '4px',
                                          color: '#ef4444',
                                          padding: '4px 8px',
                                          cursor: 'pointer',
                                          fontSize: '11px'
                                        }}
                                      >
                                        ✕
                                      </button>
                                    </div>
                                    {onDonne[`${category}::custom::${field.id}`] && (
                                      <input
                                        type="text"
                                        value={field.detail}
                                        onChange={(e) => updateCustomField(category, field.id, 'detail', e.target.value)}
                                        placeholder="Précisions..."
                                        style={{
                                          width: 'calc(100% - 24px)',
                                          marginLeft: '24px',
                                          padding: '6px 10px',
                                          background: 'rgba(30, 41, 59, 0.8)',
                                          border: '1px solid rgba(16, 185, 129, 0.3)',
                                          borderRadius: '4px',
                                          color: '#e2e8f0',
                                          fontSize: '11px'
                                        }}
                                      />
                                    )}
                                  </div>
                                ))}
                                
                                {/* Bouton ajouter champ personnalisé */}
                                <button
                                  onClick={() => addCustomField(category)}
                                  style={{
                                    width: '100%',
                                    padding: '8px',
                                    marginTop: '8px',
                                    background: 'rgba(16, 185, 129, 0.1)',
                                    border: '1px dashed rgba(16, 185, 129, 0.4)',
                                    borderRadius: '6px',
                                    color: '#10b981',
                                    cursor: 'pointer',
                                    fontSize: '12px',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    gap: '6px'
                                  }}
                                >
                                  <span>+</span> Ajouter un document personnalisé
                                </button>
                              </div>
                            )}
                          </div>
                        ))}
                      </div>
                    </div>

                    {/* ON DEMANDE */}
                    <div style={{ marginBottom: '20px' }}>
                      <h4 style={{ 
                        color: '#f59e0b', 
                        fontSize: '13px', 
                        fontWeight: 600, 
                        marginBottom: '12px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                      }}>
                        <span>❓</span> ON DEMANDE (travail à réaliser par l'étudiant)
                      </h4>
                      <textarea
                        value={onDemande}
                        onChange={(e) => setOnDemande(e.target.value)}
                        placeholder={"Décrire le travail demandé à l'étudiant...\n\nExemple :\n- Analyser le CCTP et identifier les exigences\n- Proposer une solution technique pour...\n- Réaliser un croquis de..."}
                        style={{
                          width: '100%',
                          minHeight: '150px',
                          padding: '12px',
                          background: 'rgba(30, 41, 59, 0.8)',
                          border: '1px solid rgba(245, 158, 11, 0.3)',
                          borderRadius: '8px',
                          color: '#e2e8f0',
                          fontSize: '13px',
                          resize: 'vertical',
                          lineHeight: '1.5'
                        }}
                      />
                    </div>

                    {/* SAVOIRS ASSOCIÉS */}
                    <div style={{ marginBottom: '20px' }}>
                      <h4 style={{ 
                        color: '#4ade80', 
                        fontSize: '13px', 
                        fontWeight: 600, 
                        marginBottom: '12px',
                        display: 'flex',
                        alignItems: 'center',
                        gap: '8px'
                      }}>
                        <span>📚</span> SAVOIRS ASSOCIÉS (sélectionner pour inclure dans la fiche)
                      </h4>
                      <div style={{
                        background: 'rgba(30, 41, 59, 0.5)',
                        borderRadius: '8px',
                        padding: '12px',
                        display: 'grid',
                        gridTemplateColumns: 'repeat(2, 1fr)',
                        gap: '8px'
                      }}>
                        {connaissancesGlobales.map(savoir => {
                          const isLinked = availableCompetences.some(comp => savoir.competences.includes(comp.id));
                          return (
                            <label 
                              key={savoir.id}
                              style={{ 
                                display: 'flex', 
                                alignItems: 'flex-start', 
                                gap: '8px',
                                cursor: 'pointer',
                                padding: '8px',
                                borderRadius: '6px',
                                background: selectedSavoirs[savoir.id] 
                                  ? 'rgba(74, 222, 128, 0.15)' 
                                  : isLinked 
                                    ? 'rgba(74, 222, 128, 0.05)' 
                                    : 'transparent',
                                border: selectedSavoirs[savoir.id] 
                                  ? '1px solid rgba(74, 222, 128, 0.4)' 
                                  : isLinked 
                                    ? '1px solid rgba(74, 222, 128, 0.2)' 
                                    : '1px solid transparent',
                                opacity: isLinked ? 1 : 0.5,
                                transition: 'all 0.2s ease'
                              }}
                            >
                              <input
                                type="checkbox"
                                checked={selectedSavoirs[savoir.id] || false}
                                onChange={() => setSelectedSavoirs(prev => ({
                                  ...prev,
                                  [savoir.id]: !prev[savoir.id]
                                }))}
                                style={{ 
                                  width: '16px', 
                                  height: '16px', 
                                  marginTop: '2px',
                                  accentColor: '#4ade80'
                                }}
                              />
                              <div>
                                <span style={{ 
                                  color: isLinked ? '#4ade80' : '#94a3b8', 
                                  fontWeight: 600,
                                  fontSize: '11px',
                                  marginRight: '6px'
                                }}>
                                  {savoir.id}.
                                </span>
                                <span style={{ 
                                  color: '#e2e8f0', 
                                  fontSize: '12px' 
                                }}>
                                  {savoir.nom}
                                </span>
                                {isLinked && (
                                  <span style={{
                                    marginLeft: '6px',
                                    background: 'rgba(74, 222, 128, 0.2)',
                                    color: '#4ade80',
                                    padding: '1px 5px',
                                    borderRadius: '3px',
                                    fontSize: '9px'
                                  }}>
                                    lié
                                  </span>
                                )}
                              </div>
                            </label>
                          );
                        })}
                      </div>
                    </div>

                    {/* Bouton Export PDF */}
                    <div style={{ 
                      display: 'flex', 
                      justifyContent: 'center',
                      paddingTop: '16px',
                      borderTop: '1px solid rgba(148, 163, 184, 0.2)'
                    }}>
                      <button
                        onClick={exportToPDF}
                        style={{
                          background: 'linear-gradient(135deg, #ef4444, #dc2626)',
                          border: 'none',
                          borderRadius: '10px',
                          color: 'white',
                          padding: '14px 32px',
                          cursor: 'pointer',
                          fontSize: '14px',
                          fontWeight: 600,
                          display: 'flex',
                          alignItems: 'center',
                          gap: '10px',
                          boxShadow: '0 4px 15px rgba(239, 68, 68, 0.3)',
                          transition: 'all 0.2s ease'
                        }}
                        onMouseOver={(e) => {
                          e.target.style.transform = 'translateY(-2px)';
                          e.target.style.boxShadow = '0 6px 20px rgba(239, 68, 68, 0.4)';
                        }}
                        onMouseOut={(e) => {
                          e.target.style.transform = 'translateY(0)';
                          e.target.style.boxShadow = '0 4px 15px rgba(239, 68, 68, 0.3)';
                        }}
                      >
                        <span style={{ fontSize: '18px' }}>📥</span>
                        Exporter en PDF
                      </button>
                    </div>
                  </div>
                )}
              </div>

              {/* Connaissances globales liées */}
              {availableCompetences.length > 0 && (
                <div>
                  <h3 style={{ 
                    color: '#4ade80', 
                    fontSize: '14px', 
                    fontWeight: 600, 
                    marginBottom: '16px',
                    textTransform: 'uppercase',
                    letterSpacing: '1px',
                    display: 'flex',
                    alignItems: 'center',
                    gap: '8px'
                  }}>
                    <span>📚</span> Savoirs associés (connaissances globales)
                  </h3>
                  <div style={{
                    background: 'rgba(34, 197, 94, 0.1)',
                    borderRadius: '12px',
                    padding: '16px'
                  }}>
                    {connaissancesGlobales
                      .filter(conn => availableCompetences.some(comp => conn.competences.includes(comp.id)))
                      .map(conn => (
                        <div key={conn.id} style={{
                          display: 'flex',
                          alignItems: 'center',
                          gap: '10px',
                          marginBottom: '10px',
                          padding: '8px 12px',
                          background: 'rgba(30, 41, 59, 0.4)',
                          borderRadius: '8px'
                        }}>
                          <span style={{
                            color: '#4ade80',
                            fontFamily: "'JetBrains Mono', monospace",
                            fontSize: '12px',
                            fontWeight: 600
                          }}>{conn.id}</span>
                          <span style={{ color: '#e2e8f0', fontSize: '14px' }}>{conn.nom}</span>
                          <div style={{ marginLeft: 'auto', display: 'flex', gap: '4px' }}>
                            {availableCompetences
                              .filter(comp => conn.competences.includes(comp.id))
                              .map(comp => (
                                <span key={comp.id} style={{
                                  background: 'rgba(251, 191, 36, 0.3)',
                                  color: '#fbbf24',
                                  padding: '2px 6px',
                                  borderRadius: '4px',
                                  fontSize: '10px',
                                  fontWeight: 600
                                }}>{comp.id}</span>
                              ))
                            }
                          </div>
                        </div>
                      ))
                    }
                  </div>
                </div>
              )}
            </div>
          </div>
        )}

        {/* Results */}
        <div className="glass-card" style={{ padding: '32px' }}>
          <h2 style={{ 
            fontSize: '1rem', 
            fontWeight: 600, 
            marginBottom: '24px',
            color: '#fbbf24',
            textTransform: 'uppercase',
            letterSpacing: '2px',
            display: 'flex',
            alignItems: 'center',
            gap: '10px'
          }}>
            <span style={{ 
              width: '8px', 
              height: '8px', 
              background: '#fbbf24', 
              borderRadius: '2px' 
            }} />
            Résultats
          </h2>

          {viewMode === 'connaissances' ? (
            /* Tableau Croisé Connaissances-Compétences */
            <div className="animate-in" style={{ overflowX: 'auto' }}>
              <table style={{ 
                width: '100%', 
                borderCollapse: 'collapse',
                fontSize: '12px'
              }}>
                <thead>
                  <tr>
                    <th style={{ 
                      background: 'rgba(30, 41, 59, 0.8)',
                      padding: '12px 8px',
                      textAlign: 'left',
                      borderBottom: '2px solid #fbbf24',
                      position: 'sticky',
                      left: 0,
                      zIndex: 2,
                      minWidth: '250px'
                    }}>
                      Connaissances
                    </th>
                    {data.blocs.map(bloc => (
                      <th 
                        key={bloc.id} 
                        colSpan={bloc.competences.length}
                        style={{ 
                          background: 'rgba(251, 191, 36, 0.2)',
                          padding: '8px',
                          textAlign: 'center',
                          borderBottom: '2px solid #fbbf24',
                          borderLeft: '2px solid rgba(148, 163, 184, 0.3)'
                        }}
                      >
                        <div style={{ fontWeight: 600, marginBottom: '4px', fontSize: '11px' }}>{bloc.id} - {bloc.nom}</div>
                      </th>
                    ))}
                  </tr>
                  <tr>
                    <th style={{ 
                      background: 'rgba(30, 41, 59, 0.8)',
                      padding: '8px',
                      borderBottom: '1px solid rgba(148, 163, 184, 0.2)',
                      position: 'sticky',
                      left: 0,
                      zIndex: 2
                    }}></th>
                    {data.blocs.flatMap(bloc => 
                      bloc.competences.map((comp, idx) => (
                        <th 
                          key={comp.id}
                          style={{ 
                            background: 'rgba(30, 41, 59, 0.6)',
                            padding: '8px 4px',
                            textAlign: 'center',
                            borderBottom: '1px solid rgba(148, 163, 184, 0.2)',
                            borderLeft: idx === 0 ? '2px solid rgba(148, 163, 184, 0.3)' : '1px solid rgba(148, 163, 184, 0.1)',
                            minWidth: '45px'
                          }}
                          title={comp.nom}
                        >
                          <span style={{ 
                            color: '#fbbf24', 
                            fontWeight: 700,
                            fontSize: '11px'
                          }}>
                            {comp.id}
                          </span>
                        </th>
                      ))
                    )}
                  </tr>
                </thead>
                <tbody>
                  {connaissancesGlobales.map(conn => (
                    <tr key={conn.id}>
                      <td style={{ 
                        background: 'rgba(15, 23, 42, 0.6)',
                        padding: '10px 12px',
                        borderBottom: '1px solid rgba(148, 163, 184, 0.1)',
                        position: 'sticky',
                        left: 0,
                        zIndex: 1
                      }}>
                        <span style={{ 
                          color: '#60a5fa',
                          fontFamily: "'JetBrains Mono', monospace",
                          fontSize: '11px',
                          marginRight: '10px',
                          fontWeight: 600
                        }}>
                          {conn.id}
                        </span>
                        <span style={{ color: '#e2e8f0', fontSize: '13px' }}>{conn.nom}</span>
                      </td>
                      {data.blocs.flatMap(bloc => 
                        bloc.competences.map((comp, idx) => (
                          <td 
                            key={`${conn.id}-${comp.id}`}
                            style={{ 
                              background: 'rgba(15, 23, 42, 0.4)',
                              padding: '8px',
                              textAlign: 'center',
                              borderBottom: '1px solid rgba(148, 163, 184, 0.1)',
                              borderLeft: idx === 0 ? '2px solid rgba(148, 163, 184, 0.3)' : '1px solid rgba(148, 163, 184, 0.1)'
                            }}
                          >
                            {conn.competences.includes(comp.id) && (
                              <span style={{ 
                                display: 'inline-block',
                                width: '18px',
                                height: '18px',
                                background: 'linear-gradient(135deg, #60a5fa, #3b82f6)',
                                borderRadius: '4px',
                                color: '#fff',
                                fontWeight: 700,
                                fontSize: '11px',
                                lineHeight: '18px'
                              }}>
                                ✕
                              </span>
                            )}
                          </td>
                        ))
                      )}
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          ) : viewMode === 'tableau' ? (
            /* Tableau Croisé View */
            <div className="animate-in" style={{ overflowX: 'auto' }}>
              <table style={{ 
                width: '100%', 
                borderCollapse: 'collapse',
                fontSize: '12px'
              }}>
                <thead>
                  <tr>
                    <th style={{ 
                      background: 'rgba(30, 41, 59, 0.8)',
                      padding: '12px 8px',
                      textAlign: 'left',
                      borderBottom: '2px solid #fbbf24',
                      position: 'sticky',
                      left: 0,
                      zIndex: 2,
                      minWidth: '200px'
                    }}>
                      Activités / Tâches
                    </th>
                    {data.blocs.map(bloc => (
                      <th 
                        key={bloc.id} 
                        colSpan={bloc.competences.length}
                        style={{ 
                          background: 'rgba(251, 191, 36, 0.2)',
                          padding: '8px',
                          textAlign: 'center',
                          borderBottom: '2px solid #fbbf24',
                          borderLeft: '2px solid rgba(148, 163, 184, 0.3)'
                        }}
                      >
                        <div style={{ fontWeight: 600, marginBottom: '4px' }}>{bloc.id} - {bloc.nom}</div>
                        <div style={{ fontSize: '10px', color: '#94a3b8' }}>{bloc.unite}</div>
                      </th>
                    ))}
                  </tr>
                  <tr>
                    <th style={{ 
                      background: 'rgba(30, 41, 59, 0.8)',
                      padding: '8px',
                      borderBottom: '1px solid rgba(148, 163, 184, 0.2)',
                      position: 'sticky',
                      left: 0,
                      zIndex: 2
                    }}></th>
                    {data.blocs.flatMap(bloc => 
                      bloc.competences.map((comp, idx) => (
                        <th 
                          key={comp.id}
                          style={{ 
                            background: 'rgba(30, 41, 59, 0.6)',
                            padding: '8px 4px',
                            textAlign: 'center',
                            borderBottom: '1px solid rgba(148, 163, 184, 0.2)',
                            borderLeft: idx === 0 ? '2px solid rgba(148, 163, 184, 0.3)' : '1px solid rgba(148, 163, 184, 0.1)',
                            minWidth: '50px',
                            writingMode: 'vertical-rl',
                            textOrientation: 'mixed',
                            height: '120px',
                            fontSize: '10px',
                            color: '#94a3b8'
                          }}
                          title={comp.nom}
                        >
                          <div style={{ 
                            display: 'flex', 
                            flexDirection: 'column', 
                            alignItems: 'center',
                            gap: '4px'
                          }}>
                            <span style={{ 
                              color: '#fbbf24', 
                              fontWeight: 700,
                              writingMode: 'horizontal-tb'
                            }}>
                              {comp.id}
                            </span>
                            <span style={{ 
                              maxHeight: '100px',
                              overflow: 'hidden',
                              textOverflow: 'ellipsis'
                            }}>
                              {comp.nom.length > 40 ? comp.nom.substring(0, 40) + '...' : comp.nom}
                            </span>
                          </div>
                        </th>
                      ))
                    )}
                  </tr>
                </thead>
                <tbody>
                  {data.blocs.map(bloc => (
                    <React.Fragment key={bloc.id}>
                      {bloc.poles.map((pole, poleIdx) => (
                        <React.Fragment key={pole.id}>
                          {/* Pole header row */}
                          <tr>
                            <td 
                              colSpan={1 + data.blocs.reduce((sum, b) => sum + b.competences.length, 0)}
                              style={{ 
                                background: 'rgba(251, 191, 36, 0.1)',
                                padding: '10px 12px',
                                fontWeight: 600,
                                color: '#fbbf24',
                                borderTop: poleIdx === 0 ? '2px solid rgba(251, 191, 36, 0.5)' : 'none'
                              }}
                            >
                              <span style={{ fontFamily: "'JetBrains Mono', monospace", marginRight: '8px' }}>
                                {pole.id}
                              </span>
                              {pole.nom}
                            </td>
                          </tr>
                          {/* Taches rows */}
                          {pole.taches.map(tache => (
                            <tr key={tache.id}>
                              <td style={{ 
                                background: 'rgba(15, 23, 42, 0.6)',
                                padding: '8px 12px',
                                borderBottom: '1px solid rgba(148, 163, 184, 0.1)',
                                position: 'sticky',
                                left: 0,
                                zIndex: 1
                              }}>
                                <span style={{ 
                                  color: '#c084fc',
                                  fontFamily: "'JetBrains Mono', monospace",
                                  fontSize: '11px',
                                  marginRight: '8px'
                                }}>
                                  {tache.id}
                                </span>
                                <span style={{ color: '#e2e8f0' }}>{tache.nom}</span>
                              </td>
                              {data.blocs.flatMap(b => 
                                b.competences.map((comp, idx) => (
                                  <td 
                                    key={`${tache.id}-${comp.id}`}
                                    style={{ 
                                      background: 'rgba(15, 23, 42, 0.4)',
                                      padding: '8px',
                                      textAlign: 'center',
                                      borderBottom: '1px solid rgba(148, 163, 184, 0.1)',
                                      borderLeft: idx === 0 ? '2px solid rgba(148, 163, 184, 0.3)' : '1px solid rgba(148, 163, 184, 0.1)'
                                    }}
                                  >
                                    {tache.competences?.includes(comp.id) && (
                                      <span style={{ 
                                        display: 'inline-block',
                                        width: '20px',
                                        height: '20px',
                                        background: 'linear-gradient(135deg, #fbbf24, #f59e0b)',
                                        borderRadius: '4px',
                                        color: '#0f172a',
                                        fontWeight: 700,
                                        fontSize: '12px',
                                        lineHeight: '20px'
                                      }}>
                                        ✕
                                      </span>
                                    )}
                                  </td>
                                ))
                              )}
                            </tr>
                          ))}
                        </React.Fragment>
                      ))}
                    </React.Fragment>
                  ))}
                </tbody>
              </table>
            </div>
          ) : (
            /* Competences View */
            <div>
              {!selectedBloc ? (
                <div className="empty-state">
                  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.5">
                    <path d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
                  </svg>
                  <p style={{ fontSize: '1.1rem', marginBottom: '8px' }}>Sélectionnez un bloc</p>
                  <p style={{ fontSize: '14px' }}>pour afficher les compétences associées</p>
                </div>
              ) : (
                <div>
                  {(selectedCompetence ? currentBloc?.competences.filter(c => c.id === selectedCompetence) : currentBloc?.competences)?.map(comp => (
                    <div key={comp.id} className="result-card animate-in">
                      <div style={{ 
                        display: 'flex', 
                        alignItems: 'center', 
                        gap: '12px',
                        marginBottom: '16px'
                      }}>
                        <span style={{ 
                          background: 'linear-gradient(135deg, #fbbf24, #f59e0b)',
                          color: '#0f172a',
                          padding: '6px 12px',
                          borderRadius: '8px',
                          fontWeight: 700,
                          fontFamily: "'JetBrains Mono', monospace"
                        }}>
                          {comp.id}
                        </span>
                        <h4 style={{ fontSize: '1rem', fontWeight: 600, margin: 0 }}>
                          {comp.nom}
                        </h4>
                      </div>

                      {/* Connaissances */}
                      <div style={{ marginBottom: '20px' }}>
                        <h5 style={{ 
                          fontSize: '12px', 
                          color: '#94a3b8', 
                          textTransform: 'uppercase',
                          letterSpacing: '1px',
                          marginBottom: '12px'
                        }}>
                          Connaissances associées
                        </h5>
                        <div style={{ display: 'flex', flexWrap: 'wrap', gap: '8px' }}>
                          {comp.connaissances.map((conn, i) => (
                            <div key={i} style={{ 
                              display: 'flex', 
                              alignItems: 'center', 
                              gap: '8px',
                              background: 'rgba(30, 41, 59, 0.6)',
                              padding: '8px 12px',
                              borderRadius: '8px'
                            }}>
                              <span style={{ fontSize: '13px', color: '#e2e8f0' }}>{conn.nom}</span>
                              <span className={`tag niveau-${conn.niveau}`} style={{ padding: '2px 8px', fontSize: '10px' }}>
                                N{conn.niveau}
                              </span>
                            </div>
                          ))}
                        </div>
                      </div>

                      {/* Critères */}
                      <div>
                        <h5 style={{ 
                          fontSize: '12px', 
                          color: '#94a3b8', 
                          textTransform: 'uppercase',
                          letterSpacing: '1px',
                          marginBottom: '12px'
                        }}>
                          Critères d'évaluation
                        </h5>
                        {comp.criteres.map((critere, i) => (
                          <div key={i} className="critere-item">
                            <div className="critere-check">
                              <span style={{ color: '#0f172a', fontSize: '12px' }}>✓</span>
                            </div>
                            <span style={{ fontSize: '14px', color: '#e2e8f0' }}>{critere}</span>
                          </div>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}
        </div>

        {/* Legend */}
        <div className="glass-card" style={{ 
          padding: '20px 32px', 
          marginTop: '24px',
          display: 'flex',
          alignItems: 'center',
          justifyContent: 'center',
          gap: '24px',
          flexWrap: 'wrap'
        }}>
          <span style={{ fontSize: '12px', color: '#64748b', textTransform: 'uppercase', letterSpacing: '1px' }}>
            Niveaux taxonomiques :
          </span>
          {Object.entries(niveauLabels).map(([niveau, label]) => (
            <div key={niveau} style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
              <span className={`tag niveau-${niveau}`} style={{ padding: '4px 8px', fontSize: '11px' }}>
                N{niveau}
              </span>
              <span style={{ fontSize: '12px', color: '#94a3b8' }}>{label}</span>
            </div>
          ))}
        </div>
      </div>
    </div>
  );
}

const root = ReactDOM.createRoot(document.getElementById('root'));
root.render(<FormulaireBTSEBCR />);
    </script>
</body>
</html>
